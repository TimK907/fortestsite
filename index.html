<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Universal MSAL Copilot Studio SSO Demo</title>
    <script src="https://alcdn.msauth.net/browser/2.37.0/js/msal-browser.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 2em; }
        .hidden { display: none; }
        pre { background: #f4f4f4; padding: 6px; border-radius: 4px; }
        button { margin-top: 1em; }
    </style>
</head>
<body>
    <h2>Universal SSO/Claims Demo</h2>
    <button id="loginButton">ðŸ”‘ Login with Microsoft SSO</button>
    <div id="status"></div>
    <div id="profile" class="hidden">
        <h3>Claims from accessToken / idToken:</h3>
        <ul>
            <li><b>User ID:</b> <span id="userid"></span></li>
            <li><b>Name:</b> <span id="username"></span></li>
            <li><b>Email:</b> <span id="useremail"></span></li>
        </ul>
        <details>
            <summary>Full JWT claims</summary>
            <pre id="claims"></pre>
        </details>
        <details>
            <summary>Token (for API request)</summary>
            <pre id="token"></pre>
        </details>
    </div>

    <h3>Copilot Studio SSO endpoint call (env):</h3>
    <button id="callCopilotSSOButton" class="hidden">Call Copilot Studio SSO endpoint</button>
    <pre id="copilotSSOresponse" class="hidden"></pre>

    <h3>Custom backend endpoint call (/profile):</h3>
    <button id="callBackendButton" class="hidden">Call custom backend</button>
    <pre id="backendresponse" class="hidden"></pre>

    <script>
        // === MSAL settings ===
        const msalConfig = {
            auth: {
                clientId: "20432056-2b97-43ca-9cfc-ec900428bbd4", // your Client ID
                authority: "https://login.microsoftonline.com/d06629ae-56db-44af-880b-80afafa24182", // your Tenant
                redirectUri: "https://fortestsite8.onrender.com/.auth/web/redirect"
            }
        };

        const loginRequest = {
            scopes: [
                "openid", "profile", "email"
                // add Graph API or custom backend scope here if needed
            ]
        };

        // === Copilot Studio token endpoint ===
        const copilotSSOEndpoint = "https://aa9a827baedfee7db575bfb7ebdcf7.17.environment.api.powerplatform.com/copilotstudio/dataverse-backed/authenticated/bots/cr7d7_undefinedNameOfTouristInformationAgen/conversations?api-version=2022-03-01-preview";

        // === Custom backend endpoint ===
        const backendEndpoint = "https://aa9a827baedfee7db575bfb7ebdcf7.17.environment.api.powerplatform.com/copilotstudio/dataverse-backed/authenticated/bots/cr7d7_undefinedNameOfTouristInformationAgen/conversations?api-version=2022-03-01-preview"; // change to your backend if needed

        // ==== JWT decoder (manual) ====
        function decodeJWT(token) {
            if (!token) return {};
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function (c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }

        // ==== DOM elements ====
        const loginButton = document.getElementById('loginButton');
        const statusDiv = document.getElementById('status');
        const profileDiv = document.getElementById('profile');
        const useridSpan = document.getElementById('userid');
        const usernameSpan = document.getElementById('username');
        const useremailSpan = document.getElementById('useremail');
        const claimsPre = document.getElementById('claims');
        const tokenPre = document.getElementById('token');
        const callCopilotSSOButton = document.getElementById('callCopilotSSOButton');
        const copilotSSOresponsePre = document.getElementById('copilotSSOresponse');
        const callBackendButton = document.getElementById('callBackendButton');
        const backendresponsePre = document.getElementById('backendresponse');

        // ==== State ====
        let accessToken = null, idToken = null;

        loginButton.onclick = async function() {
            statusDiv.innerText = "Logging in with Microsoft...";
            try {
                const msalInstance = new msal.PublicClientApplication(msalConfig);

                const loginResponse = await msalInstance.loginPopup(loginRequest);
                statusDiv.innerText = "Login successful. Getting token...";

                const account = msalInstance.getAllAccounts()[0];
                const tokenResponse = await msalInstance.acquireTokenSilent({
                    ...loginRequest,
                    account
                }).catch(async (e) => {
                    return msalInstance.acquireTokenPopup(loginRequest);
                });

                accessToken = tokenResponse.accessToken;
                idToken = tokenResponse.idToken || loginResponse.idToken;

                // Decode claims from accessToken (or idToken)
                let claims = {};
                if (accessToken) claims = decodeJWT(accessToken);
                if ((!claims || !claims.oid) && idToken) claims = decodeJWT(idToken);

                // Profile info
                useridSpan.textContent = claims.oid || claims.sub || "-";
                usernameSpan.textContent = claims.name || "-";
                useremailSpan.textContent = claims.preferred_username || claims.upn || claims.email || "-";

                claimsPre.textContent = JSON.stringify(claims, null, 4);
                tokenPre.textContent = accessToken;
                profileDiv.classList.remove("hidden");
                callCopilotSSOButton.classList.remove("hidden");
                callBackendButton.classList.remove("hidden");
                copilotSSOresponsePre.classList.add("hidden");
                backendresponsePre.classList.add("hidden");
                statusDiv.innerText = "Ready. You can call the Copilot Studio endpoint or backend.";

            } catch (err) {
                statusDiv.innerText = "Authorization error: " + (err.errorMessage || err.message || err.toString());
                console.error(err);
            }
        };

        // ==== Call Copilot Studio SSO endpoint ====
        callCopilotSSOButton.onclick = async function() {
            if (!accessToken) return alert("No token for request");
            statusDiv.innerText = "Calling Copilot Studio SSO endpoint...";
            try {
                const response = await fetch(copilotSSOEndpoint, {
                    method: "GET",
                    headers: { "Authorization": "Bearer " + accessToken }
                });
                const data = await response.json();
                copilotSSOresponsePre.textContent = JSON.stringify(data, null, 4);
                copilotSSOresponsePre.classList.remove("hidden");
                statusDiv.innerText = "Copilot Studio endpoint response received.";
            } catch (e) {
                copilotSSOresponsePre.textContent = "Error: " + (e.message || e.toString());
                copilotSSOresponsePre.classList.remove("hidden");
                statusDiv.innerText = "Copilot Studio SSO endpoint error!";
            }
        };

        // ==== Call custom backend endpoint ====
        callBackendButton.onclick = async function() {
            if (!accessToken) return alert("No token for request");
            statusDiv.innerText = "Calling custom backend endpoint...";
            try {
                const response = await fetch(backendEndpoint, {
                    method: "GET",
                    headers: { "Authorization": "Bearer " + accessToken }
                });
                const data = await response.json();
                backendresponsePre.textContent = JSON.stringify(data, null, 4);
                backendresponsePre.classList.remove("hidden");
                statusDiv.innerText = "Backend response received.";
            } catch (e) {
                backendresponsePre.textContent = "Error: " + (e.message || e.toString());
                backendresponsePre.classList.remove("hidden");
                statusDiv.innerText = "Backend error!";
            }
        };
    </script>
</body>
</html>
