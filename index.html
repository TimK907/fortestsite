<!DOCTYPE html>
<html lang="en">
<head>
    <title>Travel Assistant SSO</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <script src="https://cdn.botframework.com/botframework-webchat/latest/webchat.js"></script>
    <script src="https://alcdn.msauth.net/browser/2.32.0/js/msal-browser.min.js"></script>
    <style>
        body {
            margin: 0;
            min-height: 100vh;
            font-family: "Segoe UI", sans-serif;
            background: url('background.jpg') no-repeat center center fixed;
            background-size: cover;
        }
        #chatwindow {
            background: rgba(0,0,0,0.6);
            margin: 4vw auto;
            max-width: 700px;
            min-height: 80vh;
            border-radius: 24px;
            box-shadow: 0 0 24px rgba(0,0,0,0.8);
            padding-bottom: 24px;
        }
        #header {
            color: #fff;
            font-weight: bold;
            font-size: 2em;
            text-align: center;
            padding: 32px 0 0 0;
            letter-spacing: 1px;
        }
        #subheader {
            color: #fff;
            text-align: center;
            font-size: 1.2em;
            margin-bottom: 20px;
            margin-top: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        #login, #logout {
            color: #fff;
            background: #0078d4;
            border: none;
            border-radius: 5px;
            padding: 0.3em 1.5em;
            margin: 0 5px;
            cursor: pointer;
            text-decoration: none;
            font-size: 1em;
            transition: background 0.2s;
        }
        #login:hover, #logout:hover {
            background: #005a9e;
        }
        #webchat {
            margin: 0 24px;
            margin-top: 10px;
            min-height: 500px;
            background: rgba(255,255,255,0.07);
            border-radius: 12px;
        }
    </style>
</head>
<body>
    <div id="chatwindow">
        <div id="header">Welcome to Travel Assistant</div>
        <div id="subheader">
            <span id="loginStatus">Hello, Anonymous User</span>
            <button id="login" onclick="onSignInClick()">Login with Microsoft</button>
            <button id="logout" onclick="onSignOutClick()" style="display:none;">Logout</button>
        </div>
        <div id="webchat"></div>
    </div>
    <script>
        // === Заповніть цими даними свої параметри ===
        const clientId = "05bdb70e-0233-4120-8a95-5e64e9801c84"; // App Registration для сайту
        const tenantId = "d06629ae-56db-44af-880b-80afafa24182";
        // DirectLine Token Endpoint для бота
        const tokenEndpoint = "https://aa9a827baedfee7db575bfb7ebdcf7.17.environment.api.powerplatform.com/copilotstudio/dataverse-backed/authenticated/bots/cr7d7_undefinedNameOfTouristInformationAgen/conversations?api-version=2022-03-01-preview";
        // ==============================================

        const msalConfig = {
            auth: { clientId, authority: `https://login.microsoftonline.com/${tenantId}` }
        };
        const loginRequest = { scopes: ["User.Read", "openid", "profile"] };
        const msalInstance = new msal.PublicClientApplication(msalConfig);

        let user = null;
        async function onSignInClick() {
            try {
                await msalInstance.loginPopup(loginRequest);
            } catch (err) {
                console.log(err)
            }

            const accounts = msalInstance.getAllAccounts();
            if (accounts.length > 0) {
                msalInstance.setActiveAccount(accounts[0]);
                user = accounts[0];
                document.getElementById("loginStatus").innerHTML = "Hello, " + user.name;
                document.getElementById("login").style.display = "none";
                document.getElementById("logout").style.display = "inline";
                await renderChatWidget();
            }
        }
        async function onSignOutClick() {
            await msalInstance.logoutPopup({ account: user });
            location.reload();
        }

        // Init - перевіряємо чи залогінений
        (function () {
            const accounts = msalInstance.getAllAccounts();
            if (accounts.length > 0) {
                user = accounts[0];
                msalInstance.setActiveAccount(user);
                document.getElementById("loginStatus").innerHTML = "Hello, " + user.name;
                document.getElementById("login").style.display = "none";
                document.getElementById("logout").style.display = "inline";
            }
        })();

        function getOAuthCardResourceUri(activity) {
            if (activity && activity.attachments && activity.attachments[0] &&
                activity.attachments[0].contentType === 'application/vnd.microsoft.card.oauth' &&
                activity.attachments[0].content.tokenExchangeResource) {
                return activity.attachments[0].content.tokenExchangeResource.uri;
            }
        }

        async function exchangeTokenAsync(resourceUri) {
            let user = msalInstance.getAllAccounts();
            if (user.length <= 0) return null;

            const tokenRequest = { scopes: [resourceUri] };

            try {
                const tokenResponse = await msalInstance.acquireTokenSilent(tokenRequest)
                return tokenResponse.accessToken;
            } catch (err) {
                console.log(err);
                return null;
            }
        }

        async function fetchJSON(url, options = {}) {
            const res = await fetch(url, {
                ...options,
                headers: { ...options.headers, accept: 'application/json' }
            });
            if (!res.ok) throw new Error(res.status);
            return await res.json();
        }

        async function renderChatWidget() {
            var userID = user?.localAccountId ?
                (user.localAccountId).substring(0, 36) :
                (Math.random().toString() + Date.now().toString()).substring(0, 64);

            // !!! Отримання токену directline для бота (endpoint ти вказуєш свій) !!!
            const { token } = await fetchJSON(tokenEndpoint);
            const directLine = window.WebChat.createDirectLine({ token });

            const store = WebChat.createStore(
                {},
                ({ dispatch }) => next => action => {
                    if (action.type === "DIRECT_LINE/CONNECT_FULFILLED") {
                        dispatch({
                            meta: { method: "keyboard" },
                            payload: {
                                activity: {
                                    channelData: { postBack: true },
                                    name: 'startConversation',
                                    type: "event"
                                }
                            },
                            type: "DIRECT_LINE/POST_ACTIVITY",
                        });
                    }
                    if (action.type === 'DIRECT_LINE/INCOMING_ACTIVITY') {
                        const activity = action.payload.activity;
                        let resourceUri;
                        if (activity.from && activity.from.role === 'bot' && (resourceUri = getOAuthCardResourceUri(activity))) {
                            exchangeTokenAsync(resourceUri).then((token) => {
                                if (token) {
                                    directLine.postActivity({
                                        type: 'invoke',
                                        name: 'signin/tokenExchange',
                                        value: {
                                            id: activity.attachments[0].content.tokenExchangeResource.id,
                                            connectionName: activity.attachments[0].content.connectionName,
                                            token
                                        },
                                        "from": {
                                            id: userID,
                                            name: user.name,
                                            role: "user"
                                        }
                                    }).subscribe();
                                    return;
                                }
                                else {
                                    return next(action);
                                }
                            });
                        } else {
                            return next(action);
                        }
                    } else {
                        return next(action);
                    }
                });

            window.WebChat.renderWebChat(
                {
                    directLine: directLine,
                    store,
                    userID,
                    styleOptions: {
                        botAvatarInitials: 'Bot',
                        userAvatarInitials: 'U',
                        hideUploadButton: true
                    }
                },
                document.getElementById('webchat')
            );
        }

        (async () => { await renderChatWidget() })();
    </script>
</body>
</html>
