<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Travel Helper</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://alcdn.msauth.net/browser/2.39.0/js/msal-browser.min.js"></script>
  <!-- Не підключайте свій main.js ДО msal-browser.min.js! -->
</head>
<body>
  <div id="main-content">
    <div id="login-area"></div>
    <!-- Інші ваші елементи -->
  </div>
<script>
(function () {
  // Чекаємо, поки скрипт msal буде точно завантажений
  function initAfterMsal() {
    // --- MSAL CONFIG ---
    var msalConfig = {
      auth: {
        clientId: '20432056-2b97-43ca-9cfc-ec900428bbd4',
        authority: 'https://login.microsoftonline.com/d06629ae-56db-44af-880b-80afafa24182'
      }
    };
    var clientApplication = new window.msal.PublicClientApplication(msalConfig);
    var userProfile = null;

    function updateUI() {
      var area = document.getElementById("login-area");
      area.innerHTML = '';
      if (userProfile) {
        area.innerHTML = `<span>Welcome, ${userProfile.name}! You are now signed in.</span>
          <button id="ms-logout-btn">Sign out</button>`;
        document.getElementById('ms-logout-btn').onclick = msLogout;
      } else {
        area.innerHTML = `<button id="ms-login-btn">Sign in with Microsoft</button>`;
        document.getElementById('ms-login-btn').onclick = msLogin;
      }
    }

    async function msLogin() {
      try {
        const loginResp = await clientApplication.loginPopup({ scopes: ["User.Read"] });
        clientApplication.setActiveAccount(loginResp.account);
        const accessToken = (await clientApplication.acquireTokenSilent({
          scopes: ["User.Read"], account: loginResp.account
        })).accessToken;
        const prof = await fetch("https://graph.microsoft.com/v1.0/me", {
          headers: { Authorization: "Bearer " + accessToken }
        }).then(r => r.json());
        userProfile = {
          id: clientApplication.getActiveAccount().homeAccountId,
          name: prof.displayName
        };
        updateUI();
      } catch (e) { alert("Login failed! " + (e.errorMessage || e.message)); }
    }

    function msLogout() {
      clientApplication.logoutPopup();
      userProfile = null;
      updateUI();
    }

    // Restore on reload
    var accts = clientApplication.getAllAccounts();
    if (accts && accts.length) {
      clientApplication.setActiveAccount(accts[0]);
      clientApplication.acquireTokenSilent({ scopes: ["User.Read"], account: accts[0] })
        .then(tokenResp =>
          fetch("https://graph.microsoft.com/v1.0/me", { headers: { Authorization: 'Bearer ' + tokenResp.accessToken } })
            .then(r => r.json())
            .then(prof => { userProfile = { id: accts[0].homeAccountId, name: prof.displayName }; updateUI(); })
        ).catch(e => { userProfile = null; updateUI(); });
    } else {
      updateUI();
    }
  }

  // Гарантовано після msal
  if (window.msal && window.msal.PublicClientApplication) {
    initAfterMsal();
  } else {
    var msalScript = document.querySelector('script[src*="msal-browser.min.js"]');
    if (msalScript) {
      msalScript.addEventListener('load', initAfterMsal);
    } else {
      // fallback якщо скрипт ще не завантажений
      window.addEventListener('load', initAfterMsal);
    }
  }
})();
</script>
</body>
</html>
