Ось що саме потрібно зробити, щоб ① коректно працювало перемикання мови у функції lcw() та ② було явно виконано усі три кроки конфігурації MSAL (clientId / authority, token URL, userId).

--------------------------------------------------------------------
1. Виправляємо проблем-у з мовою  
   • lcw() перевіряє window.currentLanguage.  
   • Значення window.currentLanguage при завантаженні вже є, але після перемикання мови ми його не оновлювали.  
   • Достатньо додати один рядок у функцію switchLanguage (і один раз після першої ініціалізації), щоб window.currentLanguage завжди містила актуальну мову:

```javascript
// відразу після визначення currentLanguage
window.currentLanguage = currentLanguage;   // <-- додано

function switchLanguage(lang){
    currentLanguage = lang;
    localStorage.setItem("lang", lang);
    window.currentLanguage = currentLanguage;   // <-- ДОДАНО
    renderTexts();
    showStatus();
    restartChat();
}
```

lcw() залишаємо таким, як у тебе, – він просто читає window.currentLanguage щоразу, коли виджет стартує.

--------------------------------------------------------------------
2. Перевіряємо 3 кроки MSAL SSO

✔ Крок 1 – clientId / authority  
```javascript
var clientApplication;
(function (){
    var msalConfig = {
        auth: {
            clientId: '20432056-2b97-43ca-9cfc-ec900428bbd4',            // <= твій Application ID
            authority: 'https://login.microsoftonline.com/d06629ae-56db-44af-880b-80afafa24182' // <= твій tenant
        }
    };
    clientApplication = new msal.PublicClientApplication(msalConfig);
})();
```

✔ Крок 2 – token endpoint  
```javascript
(async function main() {
    var theURL = "https://aa9a827baedfee7db575bfb7ebdcf7.17.environment.api.powerplatform.com/copilotstudio/dataverse-backed/authenticated/bots/cr7d7_agentMXBot/conversations?api-version=2022-03-01-preview";
})();
```

✔ Крок 3 – userId з власним префіксом  
```javascript
function updateUserId(){
    const account = clientApplication.getActiveAccount();
    var userId = account?.homeAccountId != null ?
        ("My-custom-prefix" + account.homeAccountId).substr(0, 64) :
        (Math.random().toString() + Date.now().toString()).substr(0,64);

    /* прибираємо можливий початковий символ 'e' і tenant-частину,
       щоб залишився «чистий» GUID довжиною 36 символів */
    if(userId.includes(".")) userId = userId.split(".")[0];
    if(userId.length > 36)   userId = userId.slice(userId.length-36);

    window.userId = userId;        // доступний для chat-context
}
```

updateUserId() викликаємо:
 • одразу після успішного login  
 • при restartChat, якщо потрібно

--------------------------------------------------------------------
3. Надсилання SSO-даних у чат  
У restartChat() / startLiveChat() формуємо customContext:

```javascript
const ctx = {
    UserLanguage : { value: (currentLanguage==="fr" ? "French" : "English"), isDisplayable:true },
    Brand        : { value: brandValue,  isDisplayable:true }
};
if (clientApplication.getActiveAccount()) {
    ctx.UserName = { value: userName,  isDisplayable:true };
    ctx.Token    = { value: window.userId, isDisplayable:true };
}
```

--------------------------------------------------------------------
Після цих змін:
• lcw() завжди показує правильну локалізацію, бо window.currentLanguage синхронізується під час перемикань.  
• Усі три кроки MSAL виконані й userId (Token) передається у чат разом із UserName лише після автентифікації; Language та Brand передаються завжди.

Якщо усі кроки зрозумілі – підтверди, і я згенерую повний оновлений index.html.
