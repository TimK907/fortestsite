
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Copilot Studio Agent + SSO + Variables</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://alcdn.msauth.net/browser/2.32.0/js/msal-browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@microsoft/agents-web-sdk@latest/dist/agents-sdk.min.js"></script>
  <style>
    body { font-family: "Segoe UI", sans-serif; margin: 0; padding: 0; }
    #header { background: #0B556A; color: white; padding: 10px 20px; font-size: 18px; }
    #controls { padding: 10px 20px; background: #f3f2f1; display: flex; flex-wrap: wrap; align-items: center; gap: 10px; }
    select, button { padding: 5px 10px; font-size: 14px; }
    #webchat { height: calc(100vh - 100px); }
  </style>
</head>

<body>
  <div id="header">Copilot SDK Agent with SSO and Global Variables</div>
  <div id="controls">
    <span id="loginStatus">Not logged in</span>
    <button onclick="onSignInClick()">Log in</button>
    <button onclick="onSignOutClick()" id="logoutBtn" style="display:none;">Log out</button>

    Brand:
    <select id="brandSelect" onchange="setBrand(this.value)">
      <option value="GO">GO</option>
      <option value="UP">UP</option>
    </select>

    Language:
    <select id="languageSelect" onchange="setLanguage(this.value)">
      <option value="EN">EN</option>
      <option value="UA">UA</option>
    </select>

    <button onclick="renderAgent()">Start Chat</button>
  </div>
  <div id="webchat"></div>

  <script>
    // üëâ –ó–∞–º—ñ–Ω–∏ —Ü—ñ –∑–Ω–∞—á–µ–Ω–Ω—è –Ω–∞ —Å–≤–æ—ó
    const clientId = "20432056-2b97-43ca-9cfc-ec900428bbd4";
    const tenantId = "d06629ae-56db-44af-880b-80afafa24182";
    const agentId = "cr7d7_undefinedNameOfTouristInformationAgen";
    const environmentId = "aa9a827b-aedf-ee7d-b575-bfb7ebdcf717";

    const msalConfig = {
      auth: {
        clientId: clientId,
        authority: "https://login.microsoftonline.com/" + tenantId
      },
      cache: {
        cacheLocation: "sessionStorage",
        storeAuthStateInCookie: false
      }
    };

    const loginRequest = {
      scopes: ["https://api.businesscommunicator.microsoft.com/.default"]
    };

    const msalInstance = new msal.PublicClientApplication(msalConfig);
    let userAccount = null;
    let selectedBrand = "GO";
    let selectedLanguage = "EN";
    let accessToken = null;
    let client = null;

    function setBrand(value) { selectedBrand = value; }
    function setLanguage(value) { selectedLanguage = value; }

    async function onSignInClick() {
      try {
        const loginResponse = await msalInstance.loginPopup(loginRequest);
        const account = loginResponse.account;
        msalInstance.setActiveAccount(account);
        userAccount = account;
        document.getElementById("loginStatus").innerText = "Logged in as " + account.username;
        document.getElementById("logoutBtn").style.display = "inline";

        const tokenResponse = await msalInstance.acquireTokenSilent({ ...loginRequest, account });
        accessToken = tokenResponse.accessToken;
      } catch (err) {
        console.error("Login failed", err);
      }
    }

    async function onSignOutClick() {
      await msalInstance.logoutPopup();
      location.reload();
    }

    async function renderAgent() {
      if (!accessToken) {
        alert("You must log in first.");
        return;
      }

      if (client) {
        document.getElementById("webchat").innerHTML = ""; // Clear previous instance
      }

      client = new Microsoft365CopilotClient({
        clientId: agentId,
        environmentId: environmentId,
        auth: {
          type: "aad",
          accessToken: accessToken
        },
        variables: {
          Brand: selectedBrand,
          Language: selectedLanguage
        }
      });

      client.renderWebChat({
        container: document.getElementById("webchat")
      });
    }
  </script>
</body>
</html>
