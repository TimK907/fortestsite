<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Travel Assistance</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- MSAL for Microsoft SSO -->
    <script src="https://alcdn.msauth.net/browser/2.32.0/js/msal-browser.min.js"></script>
    <style>
        body { font-family: "Montserrat", Arial, sans-serif; background: #fafafe; margin:0; min-height:100vh; }
        .center-box { max-width: 450px; margin:80px auto 0 auto; background: #fff; border-radius: 14px; padding: 36px 40px 32px 40px; box-shadow: 0 0 22px 3px rgba(50,50,50,0.12); }
        h1 { font-size:2rem; font-weight:700; color:#1c1c1c; margin:0 0 14px 0;}
        button { background:#0256b5;color:#fff;font-weight:600;font-size:1.14rem; border:none;border-radius:6px;padding:13px 24px;cursor:pointer;width:100%;margin-top:20px;}
        button:hover { background: #12355a; }
        .statusbox {font-size:1.04rem; color:#099b26; margin-top:13px;}
    </style>
</head>
<body>
    <!-- ===== Centered SSO login section ===== -->
    <div class="center-box" id="loginArea">
        <h1>Travel Assistance</h1>
        <div style="font-size:1.11rem; color:#333; margin-bottom:24px;">
            Please sign in with your Microsoft account to begin chat.
        </div>
        <button onclick="loginWithMicrosoft()" id="loginBtn">Sign in with Microsoft</button>
        <div class="statusbox" id="ssoStatus"></div>
    </div>

    <!-- ===== Omnichannel LiveChat Widget Styles + lcw callback for labels (optional) ===== -->
    <script>
        // Optional: customize widget UI via lcw()
        function lcw() {
            return {
                styleProps: {
                    generalStyles: {
                        width: "380px",
                        height: "560px",
                        bottom: "30px",
                        right: "30px"
                    }
                }
            }
        }
    </script>
    <!-- ===== Microsoft Omnichannel LiveChatWidget for D365 Customer Service ===== -->
    <script id="Microsoft_Omnichannel_LCWidget"
            src="https://oc-cdn-ocprod.azureedge.net/livechatwidget/scripts/LiveChatBootstrapper.js"
            data-app-id="d9f84d07-eecf-4bac-8385-084026ce5750"
            data-lcw-version="prod"
            data-org-id="44e3fe33-032f-f011-9a43-002248282d3c"
            data-org-url="https://m-44e3fe33-032f-f011-9a43-002248282d3c.us.omnichannelengagementhub.com"
            data-font-family-override="Roboto"
            data-color-override="#0000FF"
            data-customization-callback="lcw">
    </script>
    <script>
        // === MSAL SSO CONFIG ===
        const msalConfig = {
            auth: {
                clientId: "89344f03-2e01-449a-9cf2-306b4545c5d0",
                authority: "https://login.microsoftonline.com/d06629ae-56db-44af-880b-80afafa24182"
            },
            cache: {
                cacheLocation: "sessionStorage",
                storeAuthStateInCookie: false
            }
        };
        const loginRequest = { scopes: ["openid", "profile"] };
        const msalInstance = new msal.PublicClientApplication(msalConfig);
        let accessToken = "";
        let userOid = "";

        // ===== MAIN SSO LOGIN HANDLER =====
        async function loginWithMicrosoft() {
            document.getElementById("ssoStatus").textContent = "";
            try {
                // 1. Log in user (popup)
                await msalInstance.loginPopup(loginRequest);
                const acc = msalInstance.getAllAccounts()[0];
                msalInstance.setActiveAccount(acc);

                // 2. Get accessToken (with "profile openid")
                const response = await msalInstance.acquireTokenSilent({ ...loginRequest, account: acc });
                accessToken = response.accessToken;
                // 3. Get userId (Azure AD "oid" claim)
                const idTokenClaims = response.idTokenClaims || {};
                userOid = idTokenClaims.oid || acc.homeAccountId || "";

                // 4. Register token for Omnichannel SDK (SSO)
                if(window.Microsoft && window.Microsoft.Omnichannel
                   && window.Microsoft.Omnichannel.LiveChatWidget
                   && window.Microsoft.Omnichannel.LiveChatWidget.SDK
                   && typeof window.Microsoft.Omnichannel.LiveChatWidget.SDK.setAuthTokenProvider === "function") {
                    window.Microsoft.Omnichannel.LiveChatWidget.SDK.setAuthTokenProvider(() => Promise.resolve(accessToken));
                } else {
                    // –Ø–∫—â–æ LiveChatWidget —â–µ –Ω–µ –ø—ñ–¥–≥—Ä—É–∑–∏–≤—Å—è ‚Äî —á–µ–∫–∞—î–º–æ
                    window.addEventListener('lcw:ready', function(){
                        window.Microsoft.Omnichannel.LiveChatWidget.SDK.setAuthTokenProvider(() => Promise.resolve(accessToken));
                    }, {once:true});
                }

                // 5. Auto-start chat: –ø—ñ–¥—Å—Ç–∞–≤ UserToken
                // –í–ê–ñ–õ–ò–í–û: —á–µ—Ä–µ–∑ customContext –¥–æ–¥–∞—î–º–æ userOid —è–∫ UserToken —Å–∞–º–µ –∑–∞ —Ç–≤–æ—ó–º –ø–æ–±–∞–∂–∞–Ω–Ω—è–º
                window.addEventListener("lcw:ready", function () {
                    window.Microsoft.Omnichannel.LiveChatWidget.SDK.startChat({
                        inNewWindow: false,
                        customContext: {
                            'UserToken': { 'value': userOid, 'isDisplayable': true }
                        }
                    });
                }, {once: true});

                // 6. Hide login UI, –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
                document.getElementById("loginArea").innerHTML = '<h1>Travel Assistance</h1><div style="font-size:1.18rem;color:#098C09;padding:40px 0 33px 0;text-align:center">Welcome! Starting chat...<br><span style="font-size:2em;">üí¨</span></div>';
            } catch (err) {
                document.getElementById("ssoStatus").textContent = "SSO login failed: " + err.message;
            }
        }

        // ===== Optional: auto-login if already signed in (SPA session) =====
        window.addEventListener("DOMContentLoaded", async function() {
            const accounts = msalInstance.getAllAccounts();
            if(accounts && accounts.length > 0){
                loginWithMicrosoft();
            }
        });
    </script>
</body>
</html>
