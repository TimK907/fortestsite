<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Universal MSAL Copilot Studio SSO Demo</title>
    <script src="https://alcdn.msauth.net/browser/2.37.0/js/msal-browser.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 2em; }
        .hidden { display: none; }
        pre { background: #f4f4f4; padding: 6px; border-radius: 4px; }
        button { margin-top: 1em; }
    </style>
</head>
<body>
    <h2>Universal SSO/Claims Demo</h2>
    <button id="loginButton">üîë Login with Microsoft SSO</button>
    <div id="status"></div>
    <div id="profile" class="hidden">
        <h3>Claims –∑ accessToken / idToken:</h3>
        <ul>
            <li><b>User ID:</b> <span id="userid"></span></li>
            <li><b>Name:</b> <span id="username"></span></li>
            <li><b>Email:</b> <span id="useremail"></span></li>
        </ul>
        <details>
            <summary>–ü–æ–≤–Ω–∏–π JWT claims</summary>
            <pre id="claims"></pre>
        </details>
        <details>
            <summary>–¢–æ–∫–µ–Ω (–¥–ª—è –∑–∞–ø–∏—Ç—É –≤ API)</summary>
            <pre id="token"></pre>
        </details>
    </div>

    <h3>–í–∏–∫–ª–∏–∫ Copilot Studio SSO endpoint (env):</h3>
    <button id="callCopilotSSOButton" class="hidden">–í–∏–∫–ª–∏–∫–∞—Ç–∏ Copilot Studio SSO endpoint</button>
    <pre id="copilotSSOresponse" class="hidden"></pre>

    <h3>–í–∏–∫–ª–∏–∫ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ backend endpoint (/profile):</h3>
    <button id="callBackendButton" class="hidden">–í–∏–∫–ª–∏–∫–∞—Ç–∏ –∫–∞—Å—Ç–æ–º–Ω–∏–π backend</button>
    <pre id="backendresponse" class="hidden"></pre>

    <script>
        // === –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –¥–ª—è MSAL ===
        const msalConfig = {
            auth: {
                clientId: "20432056-2b97-43ca-9cfc-ec900428bbd4", // —Ç–≤—ñ–π Client ID
                authority: "https://login.microsoftonline.com/d06629ae-56db-44af-880b-80afafa24182", // —Ç–≤—ñ–π Tenant
                redirectUri: "https://token.botframework.com/.auth/web/redirect"
            }
        };

        const loginRequest = {
            scopes: [
                "openid", "profile", "email"
                // –¥–æ–¥–∞–π —Ç—É—Ç scope –¥–æ Graph API —á–∏ –¥–æ —Å–≤–æ–≥–æ backend, —è–∫—â–æ —Ç—Ä–µ–±–∞
            ]
        };

        // === =>!!!<= –ü—ñ–¥—Å—Ç–∞–≤ —Ü–µ: Copilot Studio token endpoint
        const copilotSSOEndpoint = "https://aa9a827baedfee7db575bfb7ebdcf7.17.environment.api.powerplatform.com/copilotstudio/dataverse-backed/authenticated/bots/cr7d7_undefinedNameOfTouristInformationAgen/conversations?api-version=2022-03-01-preview";

        // === =>!!!<= –ü—ñ–¥—Å—Ç–∞–≤ —Ü–µ: –∫–∞—Å—Ç–æ–º–Ω–∏–π backend endpoint
        const backendEndpoint = "https://aa9a827baedfee7db575bfb7ebdcf7.17.environment.api.powerplatform.com/copilotstudio/dataverse-backed/authenticated/bots/cr7d7_undefinedNameOfTouristInformationAgen/conversations?api-version=2022-03-01-preview"; // –∑–º—ñ–Ω–∏—Ç–∏ –Ω–∞ —Å–≤—ñ–π endpoint –∑–∞ –ø–æ—Ç—Ä–µ–±–∏

        // ==== –î–µ–∫–æ–¥–µ—Ä JWT (—Ä—É—á–Ω–∏–π) ====
        function decodeJWT(token) {
            if (!token) return {};
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function (c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }

        // ==== –ï–ª–µ–º–µ–Ω—Ç–∏ DOM ====
        const loginButton = document.getElementById('loginButton');
        const statusDiv = document.getElementById('status');
        const profileDiv = document.getElementById('profile');
        const useridSpan = document.getElementById('userid');
        const usernameSpan = document.getElementById('username');
        const useremailSpan = document.getElementById('useremail');
        const claimsPre = document.getElementById('claims');
        const tokenPre = document.getElementById('token');
        const callCopilotSSOButton = document.getElementById('callCopilotSSOButton');
        const copilotSSOresponsePre = document.getElementById('copilotSSOresponse');
        const callBackendButton = document.getElementById('callBackendButton');
        const backendresponsePre = document.getElementById('backendresponse');

        // ==== –°—Ç–∞–Ω ====
        let accessToken = null, idToken = null;

        loginButton.onclick = async function() {
            statusDiv.innerText = "–õ–æ–≥—ñ–Ω —á–µ—Ä–µ–∑ Microsoft...";
            try {
                const msalInstance = new msal.PublicClientApplication(msalConfig);

                const loginResponse = await msalInstance.loginPopup(loginRequest);
                statusDiv.innerText = "–õ–æ–≥—ñ–Ω —É—Å–ø—ñ—à–Ω–∏–π. –û—Ç—Ä–∏–º—É—î–º–æ —Ç–æ–∫–µ–Ω...";

                const account = msalInstance.getAllAccounts()[0];
                const tokenResponse = await msalInstance.acquireTokenSilent({
                    ...loginRequest,
                    account
                }).catch(async (e) => {
                    return msalInstance.acquireTokenPopup(loginRequest);
                });

                accessToken = tokenResponse.accessToken;
                idToken = tokenResponse.idToken || loginResponse.idToken;

                // –î–µ–∫–æ–¥—É—î–º–æ claims –∑ accessToken (–∞–±–æ idToken)
                let claims = {};
                if (accessToken) claims = decodeJWT(accessToken);
                if ((!claims || !claims.oid) && idToken) claims = decodeJWT(idToken);

                // Profile info
                useridSpan.textContent = claims.oid || claims.sub || "-";
                usernameSpan.textContent = claims.name || "-";
                useremailSpan.textContent = claims.preferred_username || claims.upn || claims.email || "-";

                claimsPre.textContent = JSON.stringify(claims, null, 4);
                tokenPre.textContent = accessToken;
                profileDiv.classList.remove("hidden");
                callCopilotSSOButton.classList.remove("hidden");
                callBackendButton.classList.remove("hidden");
                copilotSSOresponsePre.classList.add("hidden");
                backendresponsePre.classList.add("hidden");
                statusDiv.innerText = "–ì–æ—Ç–æ–≤–æ. –ú–æ–∂–Ω–∞ –≤–∏–∫–ª–∏–∫–∞—Ç–∏ Copilot Studio endpoint —á–∏ backend.";

            } catch (err) {
                statusDiv.innerText = "–ü–æ–º–∏–ª–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó: " + (err.errorMessage || err.message || err.toString());
                console.error(err);
            }
        };

        // ==== –í–∏–∫–ª–∏–∫ Copilot Studio SSO endpoint ====
        callCopilotSSOButton.onclick = async function() {
            if (!accessToken) return alert("–ù–µ–º–∞—î —Ç–æ–∫–µ–Ω–∞ –¥–ª—è –∑–∞–ø–∏—Ç—É");
            statusDiv.innerText = "–í–∏–∫–ª–∏–∫ Copilot Studio SSO endpoint...";
            try {
                const response = await fetch(copilotSSOEndpoint, {
                    method: "GET",
                    headers: { "Authorization": "Bearer " + accessToken }
                });
                const data = await response.json();
                copilotSSOresponsePre.textContent = JSON.stringify(data, null, 4);
                copilotSSOresponsePre.classList.remove("hidden");
                statusDiv.innerText = "–í—ñ–¥–ø–æ–≤—ñ–¥—å Copilot Studio endpoint –æ—Ç—Ä–∏–º–∞–Ω–æ.";
            } catch (e) {
                copilotSSOresponsePre.textContent = "–ü–æ–º–∏–ª–∫–∞: " + (e.message || e.toString());
                copilotSSOresponsePre.classList.remove("hidden");
                statusDiv.innerText = "–ü–æ–º–∏–ª–∫–∞ Copilot Studio SSO endpoint!";
            }
        };

        // ==== –í–∏–∫–ª–∏–∫ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ backend endpoint ====
        callBackendButton.onclick = async function() {
            if (!accessToken) return alert("–ù–µ–º–∞—î —Ç–æ–∫–µ–Ω–∞ –¥–ª—è –∑–∞–ø–∏—Ç—É");
            statusDiv.innerText = "–í–∏–∫–ª–∏–∫ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ backend endpoint...";
            try {
                const response = await fetch(backendEndpoint, {
                    method: "GET",
                    headers: { "Authorization": "Bearer " + accessToken }
                });
                const data = await response.json();
                backendresponsePre.textContent = JSON.stringify(data, null, 4);
                backendresponsePre.classList.remove("hidden");
                statusDiv.innerText = "–í—ñ–¥–ø–æ–≤—ñ–¥—å backend –æ—Ç—Ä–∏–º–∞–Ω–æ.";
            } catch (e) {
                backendresponsePre.textContent = "–ü–æ–º–∏–ª–∫–∞: " + (e.message || e.toString());
                backendresponsePre.classList.remove("hidden");
                statusDiv.innerText = "–ü–æ–º–∏–ª–∫–∞ backend!";
            }
        };
    </script>
</body>
</html>
