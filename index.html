<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Travel Assistance</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://alcdn.msauth.net/browser/2.32.0/js/msal-browser.min.js"></script>
<!-- Chat widget and styles ... (your styles here) ... -->
</head>
<body>
    <!-- ... ваш UI як раніше ... -->
    <button id="msLoginBtn">Sign in with Microsoft</button>
    <button id="logoutBtn" style="display:none;">Log out</button>
    <div id="ssoStatus"></div>

<script>
// --- SIMPLE STATE ---
let accessToken = "";
let userOid = "";
let userName = "";

// MSAL
const msalConfig = {
    auth: {
        clientId: "20432056-2b97-43ca-9cfc-ec900428bbd4",
        authority: "https://login.microsoftonline.com/d06629ae-56db-44af-880b-80afafa24182"
    },
    cache: {
        cacheLocation: "sessionStorage",
        storeAuthStateInCookie: false
    }
};
const loginRequest = { scopes: ["openid", "profile"] };
const msalInstance = new msal.PublicClientApplication(msalConfig);

// MS LOGIN HANDLER (do nothing to chat widget here!)
async function loginWithMicrosoft() {
    document.getElementById("ssoStatus").textContent = "";
    try {
        await msalInstance.loginPopup(loginRequest);
        const acc = msalInstance.getAllAccounts()[0];
        msalInstance.setActiveAccount(acc);
        const response = await msalInstance.acquireTokenSilent({ ...loginRequest, account: acc });
        accessToken = response.accessToken;
        const claims = response.idTokenClaims || {};
        userOid = claims.oid || acc.homeAccountId || "";
        userName = claims.name || claims.preferred_username || "";

        document.getElementById("msLoginBtn").style.display = "none";
        document.getElementById("logoutBtn").style.display = "";
        document.getElementById("ssoStatus").textContent = "Welcome, " + (userName || "") + "!";

        // After login, close chat to force new session
        safelyCloseChat();
    } catch (err) {
        document.getElementById("ssoStatus").textContent = "SSO login failed: " + err.message;
    }
}
document.getElementById("msLoginBtn").onclick = loginWithMicrosoft;

// LOGOUT HANDLER
async function logoutMSAL() {
    try {
        await msalInstance.logoutPopup();
        accessToken = ""; userName = ""; userOid = "";
        document.getElementById("msLoginBtn").style.display = "";
        document.getElementById("logoutBtn").style.display = "none";
        document.getElementById("ssoStatus").textContent = "";

        safelyCloseChat();
    } catch (err) {
        document.getElementById("ssoStatus").textContent = "SSO logout failed: " + err.message;
    }
}
document.getElementById("logoutBtn").onclick = logoutMSAL;

// --- CLOSE CHAT CORRECTLY ON EVERY LOGIN/LOGOUT ---
function safelyCloseChat() {
    if (window.Microsoft
        && window.Microsoft.Omnichannel
        && window.Microsoft.Omnichannel.LiveChatWidget
        && window.Microsoft.Omnichannel.LiveChatWidget.SDK
        && typeof window.Microsoft.Omnichannel.LiveChatWidget.SDK.closeChat === "function") {
        window.Microsoft.Omnichannel.LiveChatWidget.SDK.closeChat();
    }
}

// ------- LCW:READY HANDLER (EVERYTHING SENSITIVE HERE --------
window.addEventListener("lcw:ready", function () {
    // 1. Register token provider if logged in, after lcw:ready only!
    if (accessToken && window.Microsoft
        && window.Microsoft.Omnichannel
        && window.Microsoft.Omnichannel.LiveChatWidget
        && window.Microsoft.Omnichannel.LiveChatWidget.SDK
        && typeof window.Microsoft.Omnichannel.LiveChatWidget.SDK.setAuthTokenProvider === "function") {
        window.Microsoft.Omnichannel.LiveChatWidget.SDK.setAuthTokenProvider(() => Promise.resolve(accessToken));
    }
    // 2. Start chat (with or without SSO context)
    window.Microsoft.Omnichannel.LiveChatWidget.SDK.startChat({
        customContext: {
            'UserName': { 'value': userName || '', 'isDisplayable': true },
            'Token': { 'value': userOid || '', 'isDisplayable': true }
        }
    });
});

// --- Restore session at page load ---
window.addEventListener("DOMContentLoaded", function() {
    const accounts = msalInstance.getAllAccounts();
    if(accounts && accounts.length > 0){
        const acc = accounts[0];
        msalInstance.setActiveAccount(acc);
        msalInstance.acquireTokenSilent({ ...loginRequest, account: acc }).then(response=>{
            accessToken = response.accessToken;
            const claims = response.idTokenClaims || {};
            userOid = claims.oid || acc.homeAccountId || "";
            userName = claims.name || claims.preferred_username || "";
            document.getElementById("msLoginBtn").style.display = "none";
            document.getElementById("logoutBtn").style.display = "";
            document.getElementById("ssoStatus").textContent = "Welcome, " + (userName || "") + "!";
        });
    } else {
        document.getElementById("msLoginBtn").style.display = "";
        document.getElementById("logoutBtn").style.display = "none";
        document.getElementById("ssoStatus").textContent = "";
    }
});
</script>

<!-- Microsoft Omnichannel LiveChatWidget -->
<script id="Microsoft_Omnichannel_LCWidget"
    src="https://oc-cdn-ocprod.azureedge.net/livechatwidget/scripts/LiveChatBootstrapper.js"
    data-app-id="20432056-2b97-43ca-9cfc-ec900428bbd4"
    data-lcw-version="prod"
    data-org-id="44e3fe33-032f-f011-9a43-002248282d3c"
    data-org-url="https://m-44e3fe33-032f-f011-9a43-002248282d3c.us.omnichannelengagementhub.com"
    data-customization-callback="lcw">
</script>
</body>
</html>
