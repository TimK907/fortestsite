<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Travel Helper - Auth+Chat POC</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body {
      margin: 0; padding: 0;
      font-family: "Segoe UI", Arial, sans-serif;
      background: url('https://images.pexels.com/photos/20409358/pexels-photo-20409358.jpeg?_gl=1*1y7tkqd*_ga*MTMxOTQ0MzI2MC4xNzUwMzI3OTQx*_ga_8JE65Q40S6*czE3NTEzNTU4MTgkbzMkZzEkdDE3NTEzNTU4NTUkajIzJGwwJGgw') no-repeat center center fixed;
      background-size: cover;
      min-height: 100vh;
      color: #222;
    }
    .overlay {
      background: rgba(245, 245, 245, 0.90);
      min-height: 100vh;
      width: 100vw;
      position: absolute;
      top: 0; left: 0;
      z-index: 0;
    }
    .container {
      position: relative;
      z-index: 1;
      max-width: 510px;
      margin-left: 32px;
      margin-top: 56px;
      background: rgba(255,255,255,0.92);
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,.1);
      padding: 40px 36px 32px 32px;
      min-height: 300px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 30px;
    }

    /* Language and chat buttons on the right */
    .top-bar {
      position: absolute;
      top: 22px;
      right: 32px;
      display: flex;
      gap: 16px;
      z-index: 3;
    }
    .lang-btn {
      border: 1px solid #399e46;
      background: #fff;
      color: #399e46;
      font-size: 1rem;
      border-radius: 20px;
      padding: 7px 18px;
      cursor: pointer;
      margin-right: 0;
      transition: background .2s, color .2s;
    }
    .lang-btn.selected, .lang-btn:hover {
      background: #399e46;
      color: #fff;
    }
    #login-area {
      display: flex;
      align-items: center;
      gap: 14px;
    }
    #login-msg {
      color: #222;
      font-weight: 600;
      margin-top: 2px;
    }
    #logout-btn {
      background: #e74c3c;
      color: #fff;
      border: none;
      border-radius: 16px;
      padding: 5px 13px;
      cursor: pointer;
      font-size: 0.96rem;
      margin-left: 10px;
      margin-top: 0;
    }
    h1 {
      margin: 0 0 6px 0;
      color: #399e46;
      letter-spacing: -1px;
      font-size: 2em;
    }
    #desc {
      margin: 0 0 4px 0;
      line-height: 1.4;
      color: #222;
      font-size: 1.14em;
    }
    #brand-select-label {
      font-weight: 600;
      font-size: 1.06em;
      margin-right: 7px;
    }
    #brand-select {
      font-size: 1em;
      padding: 6px 18px;
      border: 1.3px solid #399e46;
      border-radius: 8px;
      margin-top: 4px;
    }
    @media (max-width:600px) {
      .container { margin: 24px 8px; padding: 24px 12px;}
      .top-bar { right: 8px; top:8px; }
    }
  </style>
</head>
<body>
<div class="overlay"></div>
<div class="top-bar">
  <button class="lang-btn selected" id="lang-en">EN</button>
  <button class="lang-btn" id="lang-fr">FR</button>
</div>
<div id="chat-root"></div>

<div class="container">
  <div id="login-area">
    <button id="ms-login-btn"></button>
    <span id="login-msg"></span>
    <button id="logout-btn" style="display:none"></button>
  </div>
  <h1 id="main-title"></h1>
  <div id="desc"></div>
  <label id="brand-select-label" for="brand-select"></label>
  <select id="brand-select">
    <option value="UP">UP</option>
    <option value="GO">GO</option>
  </select>
</div>

<!-- MSAL.js for Microsoft Login -->
<script src="https://alcdn.msauth.net/browser/2.39.0/js/msal-browser.min.js"></script>
<!-- jsrsasign for JWT signing -->
<script src="https://cdn.jsdelivr.net/npm/jsrsasign"></script>

<script>
/* ---- Мови ---- */
const translations = {
  en: {
    title: "We support your journeys everywhere",
    desc: "No matter how you choose to travel, you can always rely on us for support and assistance. Focus on your experience, and let us handle the rest!",
    brand: "Brand:",
    login: "Sign in with Microsoft",
    logout: "Sign out",
    greeting: "Welcome, {username}! You are now signed in.",
  },
  fr: {
    title: "Nous vous accompagnons lors de tous vos voyages",
    desc: "Peu importe votre moyen de transport, vous pouvez toujours compter sur notre assistance et notre soutien. Profitez de votre voyage, nous nous occupons du reste !",
    brand: "Marque :",
    login: "Se connecter avec Microsoft",
    logout: "Déconnexion",
    greeting: "Bienvenue, {username} ! Vous êtes maintenant connecté.",
  }
};

let currentLang = localStorage.getItem('lang') || 'en';
let userProfile = null;
let accessToken = null;
let msalInstance = null;
// Private test RSA key for JWTs (never do this in prod!)
const test_private_key = `
-----BEGIN PRIVATE KEY-----
MIIBVwIBADANBgkqhkiG9w0BAQEFAASCAT8wggE7AgEAAkEAmQClYgv++h4FYWQz
ZSGYa01uSY0Wp+UycFt0hffQeUuZK3ay4/FJIpBj7v60SZ/qZWvd3vH3jxKQ4T1N
0u4ebQIDAQABAkAz9OTkpO2lDn3N/8wi4iFsn/rv1kU5N0ZT1d4gxXGWC/vPYwKG
EVFXRj5jWtPqjMJbMIQOj1h18lBBNMd/hCGBAiEA5HpEVTXkOj5IGRfOswAr7lu/
YeA5+xBG23hG6IbkdpsCIQCq2QOJ0TifXAlVzxuew+O76J1OSRLqRTh6my0b2Sol
wwIhAMvWKPQX1fUQd8u4I74h9hGZUwSYzjqNY16epgAfchf3AiEAqKJTmVuZGVW9
0QNnRvvRRP6S9cKYm3tzxyPu0yM8zdECIACSjN2P35k/2VN7RHloDkT4xQH16nGF
lzD3nH2byEPE
-----END PRIVATE KEY-----
`;

const test_public_key = `
-----BEGIN PUBLIC KEY-----
MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBACZApWIL/voeBWFkM2UhmGtNbmRkFqfl
MnBbdIX30HlLmSt2suPxSSKQY+7+tEmf6mVr3d7x948SkOE9TdLuHm0CAwEAAQ==
-----END PUBLIC KEY-----
`;

// -- Initialize language on load and on switch --
function applyTranslations() {
  document.getElementById('main-title').textContent = translations[currentLang].title;
  document.getElementById('desc').textContent = translations[currentLang].desc;
  document.getElementById('brand-select-label').textContent = translations[currentLang].brand;
  document.getElementById('ms-login-btn').textContent = translations[currentLang].login;
  document.getElementById('logout-btn').textContent = translations[currentLang].logout;
  // Greeting if already authorized
  if (userProfile) {
    document.getElementById('login-msg').textContent = translations[currentLang].greeting.replace("{username}", userProfile.name);
  } else {
    document.getElementById('login-msg').textContent = '';
  }
}
// Change language
document.getElementById('lang-en').onclick = function() {
  currentLang = 'en';
  localStorage.setItem('lang', 'en');
  document.getElementById('lang-en').classList.add('selected');
  document.getElementById('lang-fr').classList.remove('selected');
  applyTranslations();
};
document.getElementById('lang-fr').onclick = function() {
  currentLang = 'fr';
  localStorage.setItem('lang', 'fr');
  document.getElementById('lang-fr').classList.add('selected');
  document.getElementById('lang-en').classList.remove('selected');
  applyTranslations();
};

// --- Microsoft OAuth LOGIN ---
const msalConfig = {
  auth: {
    clientId: '71dbf740-d1db-49ec-83e0-03cac4645381', // <-- Replace with your app's clientId in production
    authority: "https://login.microsoftonline.com/common",
    redirectUri: window.location.origin + window.location.pathname, // SPA redirect
  }
};
msalInstance = new msal.PublicClientApplication(msalConfig);

async function msLogin() {
  // Attempt silent first (cache), then popup
  try {
    const loginResp = await msalInstance.loginPopup({
      scopes: [ "User.Read" ], // MS Graph permissions
      prompt: "select_account"
    });
    // token needed for MS Graph
    const tokenResp = await msalInstance.acquireTokenSilent({scopes: ["User.Read"], account: loginResp.account});
    accessToken = tokenResp.accessToken;
    // load MS Graph profile
    const prof = await fetch("https://graph.microsoft.com/v1.0/me", {
      headers: { 'Authorization': 'Bearer ' + accessToken }
    }).then(r=>r.json());
    userProfile = {
      id: prof.id,   // objectId/subject for Token
      name: prof.displayName, // Display name
      raw: prof
    };
    showLoginGreeting();
    updateChatVars();
  } catch (e) {
    alert("Login failed: "+ (e.errorMessage || e.message));
  }
}
window.onload = applyTranslations;

document.getElementById('ms-login-btn').onclick = msLogin;

// Show user greeting
function showLoginGreeting() {
  document.getElementById('login-msg').textContent =
    translations[currentLang].greeting.replace("{username}", userProfile.name);
  document.getElementById('ms-login-btn').style.display = "none";
  document.getElementById('logout-btn').style.display = "";
}
document.getElementById('logout-btn').onclick = function() {
  msalInstance.logoutPopup().then(() => {
    userProfile = null; accessToken = null;
    document.getElementById('ms-login-btn').style.display = "";
    document.getElementById('logout-btn').style.display = "none";
    document.getElementById('login-msg').textContent = "";
    updateChatVars();
  });
};


// --- BRAND-SELECT change update chat vars
document.getElementById('brand-select').onchange = updateChatVars;
function updateChatVars() {
  // Wait for chat SDK injection
  if (window.Microsoft && window.Microsoft.Omnichannel && window.Microsoft.Omnichannel.LiveChatWidget) {
    window.liveChatReadyState = false;
    Microsoft.Omnichannel.LiveChatWidget.SDK.endChat();
    setTimeout(startChat, 350);
  }
}
// Also update chat if language changed
document.getElementById('lang-en').addEventListener('click', updateChatVars);
document.getElementById('lang-fr').addEventListener('click', updateChatVars);

// --- JWT/KEY ENDPOINTS for test mode ---------------------------------
window.auth = {};
auth.getAuthenticationToken = function(callback){
  // Required claims: iss, iat, exp, sub
  // Note: Here Brand/UserLanguage/UserName go to lwicontexts if available
  let now = Math.floor(Date.now()/1000);
  let obj = {
    "sub": userProfile?.id || "",
    "lwicontexts": JSON.stringify({
      msdyn_cartvalue: "0",
      msdyn_isvip: "false",
      portalcontactid: userProfile?.id || "",

      // Our context variables
      UserLanguage: currentLang === 'en' ? "English" : "French",
      Brand: document.getElementById('brand-select').value,
      ...(userProfile ? { UserName: userProfile.name } : {}),
    }),
    "iat": now,
    "iss": "custompoc.com",
    "exp": now+3600,
    "nbf": now,
  };

  const header = { alg: "RS256", typ: "JWT" };
  try {
    const sHeader = JSON.stringify(header);
    const sPayload = JSON.stringify(obj);
    let prvKey = KEYUTIL.getKey(test_private_key);
    let sJWT = KJUR.jws.JWS.sign("RS256", sHeader, sPayload, prvKey);
    callback(sJWT);
  } catch (e) { callback(null); }
};

// Simulate publickey endpoint for chat configuration
window.__publickey_endpoint = async function(req, res) {
  return JSON.stringify([
    { kid: "test0", publicKey: btoa(test_public_key), expiry: Math.floor(Date.now()/1000) + 365*24*3600 }
  ]);
};

// ---- EMBED CHAT WIDGET ----
function getCurrentBrand() {
  return document.getElementById('brand-select')?.value || 'UP';
}
function getCurrentLanguage() {
  return currentLang === 'en' ? "English" : "French";
}
function getCurrentUser() {
  if (!userProfile) return {};
  return {
    name: userProfile.name,
    id: userProfile.id,
  };
}

// -- Chat customization callback (localized UI)
function lcw() {
    let lang = getCurrentLanguage();
    const localized_texts = {
      "English": {
        webchatTitle: "Virtual Assistant",
        webchatChatButton: "Chat",
        webchatAlertTitle: "Are you sure you want to exit the chat?",
        webchatAlertMessage: "Note: This will end your conversation, and you will lose your chat history.",
        webchatNoButton: "No",
        webchatYesButton: "Yes",
        webchatLoadingPaneTitle: "Welcome to",
        webchatLoadingPaneSubTitle: "Live Chat Support!",
        webchatLoadingPaneSpinnerText: "Loading\u2026",
      },
      "French": {
        webchatTitle: "Assistant virtuel",
        webchatChatButton: "Clavarder",
        webchatAlertTitle: "\u00CAtes-vous certain de vouloir quitter la s\u00E9ance de clavardage?",
        webchatAlertMessage: "Note\u202F: Cela mettra fin \u00E0 la conversation et vous perdrez votre historique de clavardage.",
        webchatNoButton: "Non",
        webchatYesButton: "Oui",
        webchatLoadingPaneTitle: "Bienvenue au",
        webchatLoadingPaneSubTitle: "Soutien par clavardage en direct!",
        webchatLoadingPaneSpinnerText: "Chargement\u2026",
      }
    }[lang];

    return {
      styleProps: {
        generalStyles: {
          width: "360px",
          height: "560px",
          bottom: "20px",
          right: "20px"
        }
      },
      headerProps: {
        styleProps: { generalStyleProps: { background: "#399e46" } },
        controlProps: {
          headerTitleProps: { text: localized_texts.webchatTitle },
          hideIcon: false,
          hideTitle: false,
          headerIconProps: {
            src: "https://www.svgrepo.com/show/474732/assistant.svg", alt: "Discutons"
          }
        }
      },
      loadingPaneProps: {
        styleProps: { generalStyleProps: { background: "#399e46" } },
        controlProps: {
          titleText: localized_texts.webchatLoadingPaneTitle,
          subtitleText: localized_texts.webchatLoadingPaneSubTitle,
          spinnerText: localized_texts.webchatLoadingPaneSpinnerText,
          hideSpinnerText: false,
          spinnerSize: 3,
        }
      },
      chatButtonProps: {
        controlProps: {
          hideChatTextContainer: false,
          hideChatSubtitle: true,
          titleText: localized_texts.webchatChatButton,
        }
      },
      confirmationPaneProps: {
        controlProps: {
          titleText: localized_texts.webchatAlertTitle,
          subtitleText: localized_texts.webchatAlertMessage,
          brightnessValueOnDim: "0.2",
          confirmButtonText: localized_texts.webchatYesButton,
          cancelButtonText: localized_texts.webchatNoButton,
        }
      }
    };
}

// ІНТЕГРАЦІЯ СКРИПТУ OMNICHANNEL
(function(){
  // insert chat script
  var s = document.createElement('script');
  s.src = "https://oc-cdn-ocprod.azureedge.net/livechatwidget/scripts/LiveChatBootstrapper.js";
  s.id = "Microsoft_Omnichannel_LCWidget";
  s.setAttribute('data-app-id', "d9f84d07-eecf-4bac-8385-084026ce5750");
  s.setAttribute('data-lcw-version', "prod");
  s.setAttribute('data-org-id', "44e3fe33-032f-f011-9a43-002248282d3c");
  s.setAttribute('data-org-url', "https://m-44e3fe33-032f-f011-9a43-002248282d3c.us.omnichannelengagementhub.com");
  s.setAttribute('data-font-family-override', "Monotype Corsiva");
  s.setAttribute('data-color-override', "#0000FF");
  s.setAttribute('data-customization-callback', "lcw");
  document.body.appendChild(s);
})();


// Start chat with proper context, only showing UserName and Token if authorized
function startChat() {
  if (!(window.Microsoft && window.Microsoft.Omnichannel && window.Microsoft.Omnichannel.LiveChatWidget && 
       window.Microsoft.Omnichannel.LiveChatWidget.SDK)) return;
  // Compose customContext:
  let ctx = {
    'UserLanguage': { 'value': getCurrentLanguage(), 'isDisplayable': true },
    'Brand': { 'value': getCurrentBrand(), 'isDisplayable': true },
  };
  if (userProfile) {
    ctx.UserName = { value: userProfile.name, isDisplayable: true };
    ctx.Token = { value: userProfile.id, isDisplayable: true };
  }
  Microsoft.Omnichannel.LiveChatWidget.SDK.startChat({
    inNewWindow: false,
    customContext: ctx
  });
}

// Прив'язка до lcw:ready, перемикання варіантів чату
window.addEventListener("lcw:ready", function () {
  startChat();
});
// ---- Кінець chat integration ----
</script>
</body>
</html>
