<!DOCTYPE html>
<html lang="en">
<head>
    <title>Copilot Studio SSO Test (WebChat SSO flow)</title>
    <meta charset="utf-8"/>
    <script src="https://cdn.botframework.com/botframework-webchat/latest/webchat.js"></script>
    <script src="https://alcdn.msauth.net/browser/2.37.0/js/msal-browser.min.js"></script>
    <style>
        html, body { height: 100%; margin: 0; font-family: Arial, sans-serif;}
        #container { display: flex; height: 100vh;}
        #side { width: 400px; padding: 20px; box-sizing: border-box; background: #f4f4f4;}
        #side h2 { font-size:20px; }
        #claims, #token { background:#fff; border-radius:8px; padding:10px; margin-bottom:12px; }
        #chat { flex:1; min-width: 240px; height:100vh;}
        button { padding: 7px 18px; font-size: 15px; margin-bottom:12px; }
    </style>
</head>
<body>
<div id="container">
  <div id="side">
    <h2>MSAL Login &amp; Claims</h2>
    <button id="msalSignIn">Sign in with Microsoft</button>
    <div id="msalUser" style="margin:12px 0; color:#2862af;"></div>
    <div><b>AccessToken:</b></div>
    <div id="token"></div>
    <div><b>JWT claims:</b> <small>(from access token)</small></div>
    <div id="claims"></div>
  </div>
  <div id="chat">
      <div id="webchat" style="height: 100%;"></div>
  </div>
</div>
<script>
const clientId = "20432056-2b97-43ca-9cfc-ec900428bbd4";
const tenantId = "d06629ae-56db-44af-880b-80afafa24182";
const tokenEndpoint = "https://aa9a827baedfee7db575bfb7ebdcf7.17.environment.api.powerplatform.com/copilotstudio/dataverse-backed/authenticated/bots/cr7d7_TouristInformationAgen/conversations?api-version=2022-03-01-preview";
const msalConfig = {
    auth: { clientId, authority: "https://login.microsoftonline.com/" + tenantId }
};
const loginRequest = { scopes: ["User.Read", "openid", "profile"] };
const msalInstance = new msal.PublicClientApplication(msalConfig);

let accessToken = null;
let user = null;
let msalAccount = null;

document.getElementById('msalSignIn').onclick = async () => {
    try {
        const resp = await msalInstance.loginPopup(loginRequest);
        msalAccount = msalInstance.getAllAccounts()[0];
        document.getElementById('msalUser').textContent = 'Signed in as: ' + msalAccount.username;
        // Take Graph token for claims demo:
        const atResp = await msalInstance.acquireTokenSilent({ ...loginRequest, account: msalAccount })
            .catch(() => msalInstance.acquireTokenPopup({ ...loginRequest, account: msalAccount }));
        accessToken = atResp.accessToken;
        document.getElementById('token').textContent = accessToken;
        document.getElementById('claims').textContent = JSON.stringify(parseJwt(accessToken), null, 2);
    } catch (e) {
        alert("Login failed: " + (e.message || e));
    }
};
// Helper to decode claims
function parseJwt(token) {
    if (!token) return {};
    let base64Url = token.split('.')[1];
    let base64 = base64Url.replace(/-/g,'+').replace(/_/g,'/');
    let jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
        return '%' + ('00'+c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));
    return JSON.parse(jsonPayload);
}

// --- BOT WebChat PART
async function fetchDirectLineToken() {
    // Тут треба отримати DirectLine токен; реальні Copilot Studio/channels-- це свій backend або свій сервер!
    // Якщо є API для отримання токена -- вкажи тут fetch до свого backend
    // Або постав DirectLine секрет сюди (тільки для демо)
    throw new Error("DirectLine token отримується ЗІ СВОГО BACKEND. Постав свій fetch here.");
}

// Для Copilot Studio Embed можна використати просто iframe (як у твоєму коді), АБО якщо тобі треба inject токен користувача -- доведеться робити OAuthCard-інтеграцію як у офіційному прикладі MS.

window.WebChat.renderWebChat({
    directLine: window.WebChat.createDirectLine({ token: 'DIRECT_LINE_TOKEN_OR_FROM_API' }),
    userID: msalAccount?.localAccountId || undefined,
    username: msalAccount?.username || undefined,
    styleOptions: { botAvatarInitials: 'Bot', userAvatarInitials: 'You' }
}, document.getElementById('webchat'));
</script>
</body>
</html>
