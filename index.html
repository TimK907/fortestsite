<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Travel Support</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
html,body{margin:0;padding:0;height:100%;font-family:Arial,Helvetica,sans-serif;background:url("https://images.pexels.com/photos/20409358/pexels-photo-20409358.jpeg") no-repeat center/cover;color:#fff;}
.overlay{background:rgba(0,0,0,.55);position:absolute;inset:0;}
.container{position:relative;z-index:2;padding:40px 30px;max-width:520px;}
h1,p,label,select,button{text-align:left;}
select{padding:6px 8px;margin:12px 0 18px 0;}
.langBtn,.authBtn{margin-right:8px;padding:8px 16px;border:none;cursor:pointer;border-radius:4px;font-weight:bold;}
.langBtn{background:#399e46;color:#fff;opacity:.6;}
.langBtn.active{opacity:1;background:#ffcc00;color:#000;}
.authBtn{background:#0078d4;color:#fff;}
#status{margin-top:10px;font-weight:bold;}
</style>
</head>
<body>
<div class="overlay"></div>
<div class="container">
    <div>
        <button class="langBtn" id="enBtn" data-lang="en">English</button>
        <button class="langBtn" id="frBtn" data-lang="fr">Français</button>
    </div>
    <h1 id="mainTitle"></h1>
    <p id="mainText"></p>
    <label id="brandLabel" for="brandSelect"></label>
    <select id="brandSelect">
        <option value="UP">UP</option>
        <option value="GO">GO</option>
    </select><br>
    <button class="authBtn" id="loginBtn"></button>
    <div id="status"></div>
</div>

<!-- MSAL -->
<script src="https://alcdn.msauth.net/browser/2.25.0/js/msal-browser.min.js"></script>
<script>
/* ---------------- GLOBAL STATE ---------------- */
let currentLanguage = localStorage.getItem("lang") || "en";
let brandValue      = localStorage.getItem("brand") || "UP";
let userName        = "";
let userToken       = "";     /* custom user id */
/* ---------------- LANGUAGE DATA --------------- */
const texts = {
    en:{title:"We help you on every journey",
        text:"Whatever you travel by, you can count on our support everywhere and anytime.",
        brand:"Brand:",
        login:"Log in with Microsoft",
        signed:"Signed in as "},
    fr:{title:"Nous vous aidons dans chaque voyage",
        text:"Quel que soit votre mode de voyage, vous pouvez compter sur notre soutien partout et à tout moment.",
        brand:"Marque :",
        login:"Se connecter avec Microsoft",
        signed:"Connecté : "}
};
/* ------------- MSAL CONFIG (Step 1) ----------- */
var clientApplication;
(function(){
    var msalConfig = {
        auth:{
            clientId:"20432056-2b97-43ca-9cfc-ec900428bbd4",
            authority:"https://login.microsoftonline.com/d06629ae-56db-44af-880b-80afafa24182"
        }
    };
    clientApplication = new msal.PublicClientApplication(msalConfig);
})();

/* ------------- TOKEN ENDPOINT (Step 2) -------- */
(async function main(){
    var theURL = "https://directline.botframework.com/v3/directline/tokens/generate"; // updated
})();

/* ------------- USER ID (Step 3) --------------- */
function updateUserId(){
    userToken = clientApplication.getActiveAccount()?.homeAccountId != null ?
        ("My-custom-prefix"+clientApplication.getActiveAccount().homeAccountId).substr(0,64) :
        (Math.random().toString()+Date.now().toString()).substr(0,64);
}

/* ------------- UI ----------------------------- */
function renderTexts(){
    const t = texts[currentLanguage];
    document.getElementById("mainTitle").innerText = t.title;
    document.getElementById("mainText").innerText  = t.text;
    document.getElementById("brandLabel").innerText= t.brand;
    document.getElementById("loginBtn").innerText  = t.login;
    document.documentElement.lang = currentLanguage;
    document.querySelectorAll(".langBtn").forEach(b=>b.classList.toggle("active",b.dataset.lang===currentLanguage));
}
renderTexts();

/* ---------- BRAND SELECTION ------------------- */
document.getElementById("brandSelect").value = brandValue;
document.getElementById("brandSelect").addEventListener("change",e=>{
    brandValue = e.target.value;
    localStorage.setItem("brand",brandValue);
});

/* ---------- LANGUAGE SWITCH ------------------- */
document.getElementById("enBtn").onclick = ()=>switchLang("en");
document.getElementById("frBtn").onclick = ()=>switchLang("fr");
function switchLang(l){currentLanguage=l;localStorage.setItem("lang",l);renderTexts();showStatus();}

/* ---------- LOGIN ----------------------------- */
document.getElementById("loginBtn").addEventListener("click",async ()=>{
    try{
        const resp = await clientApplication.loginPopup({scopes:["user.read"]});
        if(resp?.account){
            clientApplication.setActiveAccount(resp.account);
            userName = resp.account.name || "";
            updateUserId();
            showStatus();
        }
    }catch(e){console.log(e);}
});
function showStatus(){
    const s=document.getElementById("status");
    s.innerText=userName?texts[currentLanguage].signed+userName:"";
}
showStatus();

/* ---------- DIRECT LINE TOKEN (optional) ------ */
const BOT_SECRET = "8JmiFfIOMzdjI4LGxvuZVFy18WS0FLv38LCmdY8pM9V9yIDrNUeAJQQJ99BFAC4f1cMAArohAAABAZBS19Yb.3GsbooNGM2phmYdB1Lkalu8UJ3lDm1CskqIDfWKklY1aYdn47HkdJQQJ99BFAC4f1cMAArohAAABAZBS3gpd";
let directLineToken="";
async function fetchDirectLineToken(){
    try{
        const r = await fetch("https://directline.botframework.com/v3/directline/tokens/generate",{
            method:"POST",
            headers:{Authorization:"Bearer "+BOT_SECRET}
        });
        const j = await r.json();
        directLineToken = j.token;
    }catch(err){console.log("DL token error",err);}
}
fetchDirectLineToken();

/* ---------- EXPORT FOR LCW -------------------- */
window.appState = {
    getLang: ()=>currentLanguage,
    getBrand:()=>brandValue,
    getUserName:()=>userName,
    getUserId:  ()=>userToken
};
</script>

<!-- CHAT -->
<script>
function lcw(){
    const lang = window.appState.getLang()==="fr";
    const loc = lang?{
        title:"Assistant virtuel",chat:"Clavarder",alertTitle:"Êtes-vous certain de vouloir quitter la séance de clavardage?",
        alertMsg:"Note : Cela mettra fin à la conversation et vous perdrez votre historique de clavardage.",
        no:"Non",yes:"Oui",loadTitle:"Bienvenue au",
        loadSub:"Soutien par clavardage en direct!",loading:"Chargement…"}:
    {title:"Virtual Assistant",chat:"Chat",alertTitle:"Are you sure you want to exit the chat?",
        alertMsg:"Note: This will end your conversation, and you will lose your chat history.",
        no:"No",yes:"Yes",loadTitle:"Welcome to",loadSub:"Live Chat Support!",loading:"Loading…"};
    return{
        styleProps:{generalStyles:{width:"360px",height:"560px",bottom:"20px",right:"20px"}},
        headerProps:{styleProps:{generalStyleProps:{background:"#399e46"},
            titleStyleProps:{color:"#FFF"},minimizeButtonStyleProps:{color:"#FFF"},closeButtonStyleProps:{color:"#FFF"}},
            controlProps:{headerTitleProps:{text:loc.title},hideIcon:false,hideTitle:false,
                headerIconProps:{src:"https://www.svgrepo.com/show/474732/assistant.svg",alt:"Assistant"}}},
        loadingPaneProps:{styleProps:{generalStyleProps:{background:"#399e46"}},
            controlProps:{titleText:loc.loadTitle,subtitleText:loc.loadSub,spinnerText:loc.loading,hideSpinnerText:false,spinnerSize:3}},
        chatButtonProps:{controlProps:{hideChatTextContainer:false,hideChatSubtitle:true,titleText:loc.chat}},
        confirmationPaneProps:{controlProps:{titleText:loc.alertTitle,subtitleText:loc.alertMsg,
            brightnessValueOnDim:"0.2",confirmButtonText:loc.yes,cancelButtonText:loc.no}}
    };
}
</script>

<script id="Microsoft_Omnichannel_LCWidget"
    src="https://oc-cdn-ocprod.azureedge.net/livechatwidget/scripts/LiveChatBootstrapper.js"
    data-app-id="d9f84d07-eecf-4bac-8385-084026ce5750"
    data-lcw-version="prod"
    data-org-id="44e3fe33-032f-f011-9a43-002248282d3c"
    data-org-url="https://m-44e3fe33-032f-f011-9a43-002248282d3c.us.omnichannelengagementhub.com"
    data-font-family-override="Monotype Corsiva"
    data-color-override="#0000FF"
    data-customization-callback="lcw">
</script>

<script>
window.addEventListener("lcw:ready",function(){
    const ctx={
        'UserLanguage':{value:window.appState.getLang()==="fr"?"French":"English",isDisplayable:true},
        'Brand'       :{value:window.appState.getBrand(),isDisplayable:true}
    };
    if(window.appState.getUserName()){
        ctx.UserName={value:window.appState.getUserName(),isDisplayable:true};
        ctx.Token   ={value:window.appState.getUserId(),isDisplayable:true};
    }
    Microsoft.Omnichannel.LiveChatWidget.SDK.startChat({inNewWindow:false,customContext:ctx});
});
</script>
</body>
</html>
