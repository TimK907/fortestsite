<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Travel Support</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
html,body{margin:0;height:100%;font-family:Arial,Helvetica,sans-serif;
          background:url("https://images.pexels.com/photos/20409358/pexels-photo-20409358.jpeg") center/cover no-repeat;color:#fff}
.overlay{position:absolute;inset:0;background:rgba(0,0,0,.55)}
.container{position:relative;z-index:2;max-width:520px;padding:40px 30px}
h1,p,label,select,button{text-align:left}
select{padding:6px 8px;margin:12px 0 18px}
.langBtn,.authBtn{margin-right:8px;padding:8px 16px;border:none;cursor:pointer;border-radius:4px;font-weight:bold}
.langBtn{background:#399e46;color:#fff;opacity:.6}
.langBtn.active{opacity:1;background:#ffcc00;color:#000}
.authBtn{background:#0078d4;color:#fff}
#status{margin-top:10px;font-weight:bold}
/* SSO log panel */
#ssoLog{position:fixed;bottom:0;left:0;right:0;height:160px;background:#222;color:#0f0;font-size:12px;
        font-family:Consolas,monospace;padding:6px 8px;overflow-y:auto;white-space:pre-wrap;}
</style>
</head>
<body>
<div class="overlay"></div>
<div class="container">
    <!-- UI ---------------------------------------------------------------->
    <div>
        <button class="langBtn" id="enBtn" data-lang="en">English</button>
        <button class="langBtn" id="frBtn" data-lang="fr">Français</button>
    </div>
    <h1 id="mainTitle"></h1>
    <p id="mainText"></p>
    <label id="brandLabel" for="brandSelect"></label>
    <select id="brandSelect">
        <option value="UP">UP</option>
        <option value="GO">GO</option>
    </select><br>
    <button class="authBtn" id="loginBtn"></button>
    <button class="authBtn" id="logoutBtn" style="display:none;"></button>
    <div id="status"></div>
</div>

<!-- SSO LOG PANEL -->
<div id="ssoLog"></div>

<!-- MSAL ============================================================= -->
<script src="https://alcdn.msauth.net/browser/2.25.0/js/msal-browser.min.js"></script>
<script>
/* ---------- SSO LOG HELPER ---------- */
function ssoLog(msg){
    const area=document.getElementById('ssoLog');
    const time=new Date().toLocaleTimeString();
    area.textContent += `[${time}] ${msg}\n`;
    area.scrollTop = area.scrollHeight;
    console.log("SSO:",msg);
}

/* ---------- GLOBAL STATE ---------- */
let currentLanguage = localStorage.getItem("lang") || "en";
let brandValue      = localStorage.getItem("brand") || "UP";
let userName        = "";
var userId          = "";             // Token
window.currentLanguage = currentLanguage;  // for lcw()

/* ---------- MSAL CONFIG (STEP-1) ---------- */
var clientApplication;
(function(){
   var msalConfig = {
       auth:{
           clientId : '20432056-2b97-43ca-9cfc-ec900428bbd4',
           authority: 'https://login.microsoftonline.com/d06629ae-56db-44af-880b-80afafa24182'
       }
   };
   clientApplication = new msal.PublicClientApplication(msalConfig);
   ssoLog("MSAL configured");
})();

/* ---------- TOKEN ENDPOINT VAR (STEP-2) ---------- */
(async function main(){
   var theURL = "https://aa9a827baedfee7db575bfb7ebdcf7.17.environment.api.powerplatform.com/powervirtualagents/botsbyschema/cr7d7_agentMXBot/directline/token?api-version=2022-03-01-preview";
   ssoLog("Token endpoint set: "+theURL);
})();

/* ---------- userId CREATION  (STEP-3) ---------- */
function updateUserId(){
   const acc = clientApplication.getActiveAccount();
   if(!acc){ userId=""; return; }
   userId = ("My-custom-prefix" + acc.homeAccountId).substr(0,64);
   if(userId.includes(".")) userId = userId.split(".")[0];
   if(userId.length>36)     userId = userId.slice(userId.length-36);
   ssoLog("userId created: "+userId);
}

/* ---------- UI TEXTS ---------- */
const T={
 en:{h:"We help you on every journey",p:"Whatever you travel by, you can count on our support everywhere and anytime.",b:"Brand:",in:"Log in with Microsoft",out:"Sign out",s:"Signed in as "},
 fr:{h:"Nous vous aidons dans chaque voyage",p:"Quel que soit votre mode de voyage, vous pouvez compter sur notre soutien partout et à tout moment.",b:"Marque :",in:"Se connecter avec Microsoft",out:"Se déconnecter",s:"Connecté : "}
};
function render(){
 const t=T[currentLanguage];
 document.getElementById("mainTitle").innerText=t.h;
 document.getElementById("mainText").innerText =t.p;
 document.getElementById("brandLabel").innerText=t.b;
 document.getElementById("loginBtn").innerText =t.in;
 document.getElementById("logoutBtn").innerText=t.out;
 document.querySelectorAll(".langBtn").forEach(b=>b.classList.toggle("active",b.dataset.lang===currentLanguage));
 showStatus();
}
function showStatus(){
 const st=document.getElementById("status");
 if(userName){st.innerText=T[currentLanguage].s+userName;document.getElementById("loginBtn").style.display="none";document.getElementById("logoutBtn").style.display="";}
 else        {st.innerText="";document.getElementById("loginBtn").style.display="";document.getElementById("logoutBtn").style.display="none";}
}
render();

/* ---------- EVENTS ---------- */
document.getElementById("enBtn").onclick=()=>{localStorage.setItem("lang","en");location.reload();}
document.getElementById("frBtn").onclick=()=>{localStorage.setItem("lang","fr");location.reload();}
document.getElementById("brandSelect").value=brandValue;
document.getElementById("brandSelect").addEventListener("change",e=>{localStorage.setItem("brand",e.target.value);location.reload();});

/* ---------- LOGIN / LOGOUT ---------- */
document.getElementById("loginBtn").onclick=async()=>{
  try{
     ssoLog("Opening MSAL loginPopup…");
     const r=await clientApplication.loginPopup({scopes:["user.read"]});
     if(r?.account){
        clientApplication.setActiveAccount(r.account);
        userName=r.account.name||"";
        updateUserId();
        ssoLog("Login success for "+userName);
        sessionStorage.setItem("reloaded","1");
        location.reload();
     }
  }catch(e){ssoLog("Login error: "+e.message);}
};
document.getElementById("logoutBtn").onclick=async()=>{
  try{
      await clientApplication.logoutPopup({account:clientApplication.getActiveAccount()});
      ssoLog("User logged out");
  }catch(e){ssoLog("Logout error: "+e.message);}
  sessionStorage.setItem("reloaded","1");location.reload();
};
(function restore(){
  if(sessionStorage.getItem("reloaded")){
      sessionStorage.removeItem("reloaded");
      const acc=clientApplication.getAllAccounts()[0];
      if(acc){clientApplication.setActiveAccount(acc);userName=acc.name||"";updateUserId();ssoLog("Session restored for "+userName);}
      render();
  }
})();

/* ---------- CHAT CONTEXT BUILDER ---------- */
function buildContext(){
  const ctx={
     UserLanguage:{value:(currentLanguage==="fr"?"French":"English"),isDisplayable:true},
     Brand       :{value:brandValue,isDisplayable:true}
  };
  if(userName){
     ctx.UserName={value:userName,isDisplayable:true};
     ctx.Token   ={value:userId ,isDisplayable:true};
  }
  ssoLog("Chat context prepared: "+JSON.stringify(ctx));
  return ctx;
}
</script>

<!-- ========= ORIGINAL CHAT SCRIPTS (UNMODIFIED) ========= -->
<!-- … (залишаємо без змін увесь блок lcw та LiveChatBootstrapper) … -->

<script>
// Ready event listener
window.addEventListener("lcw:ready", function () {
    try{ ssoLog("Calling closeChat…"); Microsoft.Omnichannel.LiveChatWidget.SDK.closeChat(); }catch(e){ssoLog("closeChat error (ignored): "+e.message);}
    ssoLog("Starting chat with context");
    Microsoft.Omnichannel.LiveChatWidget.SDK.startChat({
        inNewWindow:false,
        customContext: buildContext()
    });
});
</script>
</body>
</html>
