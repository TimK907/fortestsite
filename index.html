<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=360, initial-scale=1.0">
    <title>Travel Support</title>
    <style>
        html, body { height: 100%; margin: 0; padding: 0; }
        body {
            min-height: 100vh; width: 100vw;
            background-image: url('https://images.pexels.com/photos/20409358/pexels-photo-20409358.jpeg?_gl=1*1y7tkqd*_ga*MTMxOTQ0MzI2MC4xNzUwMzI3OTQx*_ga_8JE65Q40S6*czE3NTEzNTU4MTgkbzMkZzEkdDE3NTEzNTU4NTUkajIzJGwwJGgw');
            background-size: cover;
            background-position: center;
            font-family: Arial, sans-serif;
        }
        .content-block {
            background: rgba(255,255,255,0.87);
            margin: 32px;
            padding: 28px 32px 32px 32px;
            border-radius: 18px;
            box-shadow: 0 10px 28px 0 rgba(0,0,0,0.08),0 2px 4px 0 rgba(0,0,0,0.04);
            max-width: 590px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .lang-btns { margin: 0 0 16px 0; display: flex; gap: 10px; }
        h1 { text-align: left; color: #15341a; margin-bottom: 16px;}
        p { text-align: left; max-width: 500px; color: #1a282e; font-size: 1.12em; margin: 0 0 30px 0;}
        .selectors { margin-bottom: 30px; display: flex; flex-direction: row; gap: 20px;}
        label { margin-right: 12px; min-width: 64px; display: inline-block;}
        input[type="text"], select { padding: 5.5px 10px; border-radius: 4px; border: 1px solid #bbb; }
        .auth-btns { margin-bottom: 40px; display: flex; gap: 15px;}
        #ms-login, #ms-logout { background: #399e46; color: white; border: none; border-radius: 5px; font-size: 1em; padding: 9px 22px; cursor: pointer;}
        #ms-logout {background: #b50606;}
        #ms-login:disabled, #ms-logout:disabled { opacity: 0.5; cursor: not-allowed;}
        @media (max-width: 700px) {
            .content-block {max-width: 98vw; margin: 16px 3vw; padding: 18px 10px 20px 10px;}
        }
    </style>
    <script src="https://alcdn.msauth.net/browser/2.38.1/js/msal-browser.min.js"></script>
</head>
<body>
    <div class="content-block">
        <div class="lang-btns">
            <button id="en-btn" type="button">English</button>
            <button id="fr-btn" type="button">Français</button>
        </div>
        <h1 id="site-title">
            We make every journey easier for you
        </h1>
        <p id="site-desc">
            Whether you travel by air, road, rail, or sea, you can always rely on our trustworthy support. Your comfort, safety, and experience are our priority – anywhere, anytime.
        </p>
        <div class="selectors">
            <div>
                <label for="brand-select" id="brand-label">Brand:</label>
                <select id="brand-select">
                    <option value="UP">UP</option>
                    <option value="GO">GO</option>
                </select>
            </div>
        </div>
        <div class="auth-btns">
            <button id="ms-login">Log In with Microsoft</button>
            <button id="ms-logout" style="display:none;">Log Out</button>
            <span id="auth-username" style="margin-left:10px; font-weight:bold;"></span>
        </div>
    </div>
<script>
    // Language, MSAL, and translation logic
    let userLanguage = localStorage.getItem("lang") || "English";
    const translations = {
        'English': {
            title: 'We make every journey easier for you',
            desc: 'Whether you travel by air, road, rail, or sea, you can always rely on our trustworthy support. Your comfort, safety, and experience are our priority – anywhere, anytime.',
            brand: 'Brand:',
            ms_login: 'Log In with Microsoft',
            ms_logout: 'Log Out'
        },
        'French': {
            title: 'Nous facilitons chacun de vos voyages',
            desc: 'Que vous voyagiez par avion, par route, par rail ou par mer, vous pouvez toujours compter sur notre soutien fiable. Votre confort, votre sécurité et votre expérience sont notre priorité – partout, à tout moment.',
            brand: 'Marque :',
            ms_login: 'Se connecter avec Microsoft',
            ms_logout: 'Se déconnecter'
        }
    };

    function setLanguage(lang, reload = true) {
        userLanguage = lang;
        localStorage.setItem("lang", lang);
        if (reload) window.location.reload(true);
    }
    document.getElementById('en-btn').addEventListener('click', function() { setLanguage('English'); });
    document.getElementById('fr-btn').addEventListener('click', function() { setLanguage('French'); });
    function updateLangUI() {
        let tr = translations[userLanguage];
        document.getElementById('site-title').innerText = tr.title;
        document.getElementById('site-desc').innerText = tr.desc;
        document.getElementById('brand-label').innerText = tr.brand;
        document.getElementById('ms-login').innerText = tr.ms_login;
        document.getElementById('ms-logout').innerText = tr.ms_logout;
        if(userLanguage === "English"){
            document.getElementById('en-btn').style.fontWeight='bold';
            document.getElementById('fr-btn').style.fontWeight='';
        }else{
            document.getElementById('fr-btn').style.fontWeight='bold';
            document.getElementById('en-btn').style.fontWeight='';
        }
    }

    // Brand persistence
    let brand = localStorage.getItem("brand") || "UP";
    document.getElementById('brand-select').value = brand;
    document.getElementById('brand-select').addEventListener('change', function(){
        brand = this.value;
        localStorage.setItem("brand", brand);
        window.location.reload(true);
    });

    // MSAL config
    let msalToken = null;
    let msalAccount = null;
    let isAuthenticated = false;
    const msalConfig = {
      auth: {
        clientId: "20432056-2b97-43ca-9cfc-ec900428bbd4",
        authority: "https://login.microsoftonline.com/d06629ae-56db-44af-880b-80afafa24182",
        redirectUri: window.location.origin + window.location.pathname,
      }
    };
    const msalInstance = new msal.PublicClientApplication(msalConfig);

    async function msLogin() {
        try {
            const loginResponse = await msalInstance.loginPopup({ scopes: ["openid", "profile", "email"] });
            msalAccount = loginResponse.account;
            const tokenResponse = await msalInstance.acquireTokenSilent({ scopes: ["openid", "profile", "email"], account: msalAccount });
            msalToken = tokenResponse.idToken;
            isAuthenticated = true;
            localStorage.setItem("msalAccount", JSON.stringify(msalAccount));
            localStorage.setItem("msalToken", msalToken);
            localStorage.setItem("isAuthenticated", "true");
            document.getElementById('auth-username').innerText = msalAccount.name || "";
            document.getElementById('ms-login').style.display = "none";
            document.getElementById('ms-logout').style.display = "";
            window.location.reload(true);
        } catch (err) {
            alert("Microsoft Login failed.");
        }
    }
    function msLogout() {
        msalInstance.logoutPopup();
        localStorage.removeItem("msalAccount");
        localStorage.removeItem("msalToken");
        localStorage.removeItem("isAuthenticated");
        window.location.reload(true);
    }
    function restoreAuthState(){
        let acc = localStorage.getItem("msalAccount");
        let tok = localStorage.getItem("msalToken");
        let isAuth = localStorage.getItem("isAuthenticated")==="true";
        if(acc && tok && isAuth){
            msalAccount = JSON.parse(acc);
            msalToken = tok;
            isAuthenticated = true;
            document.getElementById('auth-username').innerText = msalAccount.name || "";
            document.getElementById('ms-login').style.display = "none";
            document.getElementById('ms-logout').style.display = "";
        }else{
            document.getElementById('ms-login').style.display = "";
            document.getElementById('ms-logout').style.display = "none";
            document.getElementById('auth-username').innerText = '';
        }
    }
    document.getElementById('ms-login').addEventListener('click', msLogin);
    document.getElementById('ms-logout').addEventListener('click', msLogout);

    updateLangUI();
    restoreAuthState();
</script>
<script>
    // Build chat context only if user authenticated
    function getCurrentChatContext() {
        let lang = localStorage.getItem("lang") || "English";
        let brand = document.getElementById('brand-select') ? document.getElementById('brand-select').value : (localStorage.getItem("brand") || "UP");
        let isAuth = localStorage.getItem("isAuthenticated")==="true";
        let msalAccRaw = localStorage.getItem("msalAccount");
        if(isAuth && msalAccRaw) {
            let msalAcc = JSON.parse(msalAccRaw);
            return {
                'UserLanguage': { 'value': lang === "French" ? "French" : "English", 'isDisplayable': true },
                'Brand': { 'value': brand, 'isDisplayable': true },
                'UserName': { 'value': msalAcc.name || "", 'isDisplayable': true },
                'Token': { 'value': msalAcc.homeAccountId || "", 'isDisplayable': true }
            };
        } else {
            return {
                'UserLanguage': { 'value': lang === "French" ? "French" : "English", 'isDisplayable': true },
                'Brand': { 'value': brand, 'isDisplayable': true },
                'UserName': { 'value': "", 'isDisplayable': true },
                'Token': { 'value': "", 'isDisplayable': true }
            };
        }
    }
    function getCurrentAuthToken() {
        return localStorage.getItem('msalToken') || "";
    }
    // Chat UI customization (language)
    function lcw() {
        let lang = localStorage.getItem('lang') || "English";
        let localized_texts = {
            webchatTitle: "Virtual Assistant",
            webchatChatButton: "Chat",
            webchatAlertTitle: "Are you sure you want to exit the chat?",
            webchatAlertMessage: "Note: This will end your conversation, and you will lose your chat history.",
            webchatNoButton: "No",
            webchatYesButton: "Yes",
            webchatLoadingPaneTitle: "Welcome to",
            webchatLoadingPaneSubTitle: "Live Chat Support!",
            webchatLoadingPaneSpinnerText: "Loading\u2026",
        }
        if (lang === "French") {
            localized_texts.webchatTitle = "Assistant virtuel";
            localized_texts.webchatChatButton = "Clavarder";
            localized_texts.webchatAlertTitle = "\u00CAtes-vous certain de vouloir quitter la s\u00E9ance de clavardage?";
            localized_texts.webchatAlertMessage = "Note\u202F: Cela mettra fin \u00E0 la conversation et vous perdrez votre historique de clavardage.";
            localized_texts.webchatNoButton = "Non";
            localized_texts.webchatYesButton = "Oui";
            localized_texts.webchatLoadingPaneTitle = "Bienvenue au";
            localized_texts.webchatLoadingPaneSubTitle = "Soutien par clavardage en direct!";
            localized_texts.webchatLoadingPaneSpinnerText = "Chargement\u2026";
        }
        return {
            styleProps: {
                generalStyles: {
                    width: "360px",
                    height: "560px",
                    bottom: "20px",
                    right: "20px"
                }
            },
            headerProps: {
                styleProps: {
                    generalStyleProps: { background: "#399e46" },
                    titleStyleProps: { color: "#FFFFFF" },
                    minimizeButtonStyleProps: { color: "#FFFFFF" },
                    closeButtonStyleProps: { color: "#FFFFFF" }
                },
                controlProps: {
                    headerTitleProps: { text: localized_texts.webchatTitle },
                    hideIcon: false, hideTitle: false,
                    headerIconProps: {
                        src: "https://www.svgrepo.com/show/474732/assistant.svg",
                        alt: "Discutons"
                    }
                }
            },
            loadingPaneProps: {
                styleProps: { generalStyleProps: { background: "#399e46" } },
                controlProps: {
                    titleText: localized_texts.webchatLoadingPaneTitle,
                    subtitleText: localized_texts.webchatLoadingPaneSubTitle,
                    spinnerText: localized_texts.webchatLoadingPaneSpinnerText,
                    hideSpinnerText: false, spinnerSize: 3,
                }
            },
            chatButtonProps: {
                controlProps: {
                    hideChatTextContainer: false,
                    hideChatSubtitle: true,
                    titleText: localized_texts.webchatChatButton,
                }
            },
            confirmationPaneProps: {
                controlProps: {
                    titleText: localized_texts.webchatAlertTitle,
                    subtitleText: localized_texts.webchatAlertMessage,
                    brightnessValueOnDim: "0.2",
                    confirmButtonText: localized_texts.webchatYesButton,
                    cancelButtonText: localized_texts.webchatNoButton,
                }
            }
        };
    }
    window.lcw = lcw;
</script>
<script id="Microsoft_Omnichannel_LCWidget"
    src="https://oc-cdn-ocprod.azureedge.net/livechatwidget/scripts/LiveChatBootstrapper.js"
    data-app-id="d9f84d07-eecf-4bac-8385-084026ce5750"
    data-lcw-version="prod"
    data-org-id="44e3fe33-032f-f011-9a43-002248282d3c"
    data-org-url="https://m-44e3fe33-032f-f011-9a43-002248282d3c.us.omnichannelengagementhub.com"
    data-font-family-override="Monotype Corsiva"
    data-color-override="#0000FF"
    data-customization-callback="lcw">
</script>
<script>
    // Start chat with correct variables
    window.addEventListener("lcw:ready", function () {
        var authToken = getCurrentAuthToken();
        if(authToken) {
            Microsoft.Omnichannel.LiveChatWidget.SDK.setAuthToken(authToken);
        }
        Microsoft.Omnichannel.LiveChatWidget.SDK.startChat({
            inNewWindow: false,
            customContext: getCurrentChatContext()
        });
    });

    // End chat completely and clear storage (chat is fully reset after closeChat)
    function restartChat() {
        if (
            window.Microsoft
            && Microsoft.Omnichannel
            && Microsoft.Omnichannel.LiveChatWidget
            && Microsoft.Omnichannel.LiveChatWidget.SDK
            && Microsoft.Omnichannel.LiveChatWidget.SDK.closeChat
        ) {
            Microsoft.Omnichannel.LiveChatWidget.SDK.closeChat();
        }
        // (optionally clear previous storage keys for chat history if needed)
        if (window.sessionStorage) {
            for(let k in sessionStorage){
                if(k && typeof k === "string" && k.indexOf("lcw") === 0) sessionStorage.removeItem(k);
            }
        }
        if (window.localStorage) {
            for(let k in localStorage){
                if(k && typeof k === "string" && k.indexOf("lcw") === 0) localStorage.removeItem(k);
            }
        }
    }
    document.getElementById('ms-logout').addEventListener('click', restartChat);
    document.getElementById('en-btn').addEventListener('click', restartChat);
    document.getElementById('fr-btn').addEventListener('click', restartChat);
    document.getElementById('brand-select').addEventListener('change', restartChat);
</script>
</body>
</html>
