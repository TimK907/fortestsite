<!DOCTYPE html>
<html lang="en">
<head>
    <title>Travel Assistant SSO</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.botframework.com/botframework-webchat/latest/webchat.js"></script>
    <script src="https://alcdn.msauth.net/browser/2.32.0/js/msal-browser.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
        }
        body {
            min-height: 100vh;
            background: url('background.jpg') no-repeat center center fixed;
            background-size: cover;
        }
        #main-container {
            width: 100vw;
            min-height: 100vh;
            background: rgba(0,0,0,0.6);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #header-row {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 32px;
            margin-bottom: 10px;
            font-size: 1.3em;
            font-family: "Segoe UI", sans-serif;
            color: #fff;
        }
        .icon-btn {
            color: white;
            background: transparent;
            border: none;
            cursor: pointer;
            margin-left: 8px;
            font-size: 1.25em;
            vertical-align: middle;
            transition: color 0.2s;
        }
        .icon-btn:hover {
            color: #ffae00;
        }
        #welcome-title {
            color: white;
            font-size: 2.5em;
            font-family: "Segoe UI", sans-serif;
            font-weight: bold;
            text-shadow: 2px 2px 10px #444;
            margin-bottom: 18px;
            margin-top: 10px;
            text-align: center;
            letter-spacing: 2px;
        }
        #login-btn {
            padding: 12px 32px;
            font-size: 1em;
            margin: 24px auto 0;
            color: white;
            background: #0078d4;
            border: none;
            border-radius: 5px;
            display: block;
            box-shadow: 0 2px 8px #3337;
            cursor: pointer;
            transition: background 0.2s;
        }
        #login-btn:hover {
            background: #005fa3;
        }
        #webchat-container {
            max-width: 750px;
            width: 94vw;
            height: 55vh;
            background: rgba(255,255,255,0.07);
            border-radius: 15px;
            box-shadow: 0 0 24px #2229;
            transition: background 0.2s;
            margin-bottom: 25px;
        }
        #iframe-title {
            color: white;
            font-size: 1.25em;
            margin-bottom: 9px;
            text-align: center;
        }
        #bot-iframe {
            width: 94vw;
            max-width: 750px;
            height: 32vh;
            border: none;
            border-radius: 16px;
            box-shadow: 0 0 16px #0005;
            margin-bottom: 50px;
        }
    </style>
</head>
<body>
<div id="main-container">
    <div id="header-row">
        <span id="user-info">
            <i class="fa-regular fa-user" id="user-icon"></i>
            <span id="user-text">Hello, Anonymous User</span>
        </span>
        <button class="icon-btn" id="logout-btn" style="display:none;" title="Logout">
            <i class="fa-solid fa-right-from-bracket"></i>
        </button>
    </div>

    <div id="welcome-title">Welcome to Travel Assistant</div>
    <button id="login-btn">Login with Microsoft</button>

    <!-- Справжній SSO WebChat (який інтегрує токен MSAL у DirectLine)-->
    <div id="webchat-container"></div>

    <!-- Просто "картинка": iframe Copilot Studio Webchat, SSO не працює, тільки для вигляду -->
    <div id="iframe-title">Demo Webchat (iframe from Copilot Studio, for appearance only)</div>
    <iframe
        id="bot-iframe"
        src="https://copilotstudio.microsoft.com/environments/aa9a827b-aedf-ee7d-b575-bfb7ebdcf717/bots/cr7d7_undefinedNameOfTouristInformationAgen/webchat?__version__=2"
        allow="clipboard-write; clipboard-read"
    ></iframe>
</div>

<script>
    // === App1 ===
    const clientId = "05bdb70e-0233-4120-8a95-5e64e9801c84";
    const tenantId = "d06629ae-56db-44af-880b-80afafa24182";
    // === DirectLine Token Endpoint ==
    const tokenEndpoint = "https://aa9a827baedfee7db575bfb7ebdcf7.17.environment.api.powerplatform.com/copilotstudio/dataverse-backed/authenticated/bots/cr7d7_undefinedNameOfTouristInformationAgen/conversations?api-version=2022-03-01-preview";

    const msalConfig = {
        auth: { clientId, authority: `https://login.microsoftonline.com/${tenantId}` }
    };
    const loginRequest = { scopes: ["User.Read", "openid", "profile"] };
    const msalInstance = new msal.PublicClientApplication(msalConfig);

    let account = null;

    // UI Elements
    const loginBtn = document.getElementById('login-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const userText = document.getElementById('user-text');
    const userIcon = document.getElementById('user-icon');
    const webchatContainer = document.getElementById('webchat-container');

    // Login handler
    async function handleLogin() {
        try {
            await msalInstance.loginPopup(loginRequest);
            setUI();
            renderChatWidget();
        } catch(e) {
            alert("Login failed:\n" + e);
        }
    }

    async function handleLogout() {
        await msalInstance.logoutPopup({ account });
        location.reload();
    }

    function setUI() {
        const accts = msalInstance.getAllAccounts();
        if (accts.length > 0) {
            account = accts[0];
            userIcon.className = "fa-solid fa-user";
            userText.textContent = `Hello, ${account.name}`;
            logoutBtn.style.display = "inline-block";
            loginBtn.style.display = "none";
        } else {
            account = null;
            userIcon.className = "fa-regular fa-user";
            userText.textContent = `Hello, Anonymous User`;
            logoutBtn.style.display = "none";
            loginBtn.style.display = "block";
        }
    }

    loginBtn.onclick = handleLogin;
    logoutBtn.onclick = handleLogout;

    // SSO stuff for directline
    function getOAuthCardResourceUri(activity) {
        if (
            activity && activity.attachments && activity.attachments[0] &&
            activity.attachments[0].contentType === 'application/vnd.microsoft.card.oauth' &&
            activity.attachments[0].content.tokenExchangeResource
        ) {
            return activity.attachments[0].content.tokenExchangeResource.uri;
        }
    }

    async function exchangeTokenAsync(resourceUri) {
        let user = msalInstance.getAllAccounts();
        if (user.length <= 0) return null;

        const tokenRequest = { scopes: [resourceUri] };

        try {
            const tokenResponse = await msalInstance.acquireTokenSilent(tokenRequest)
            return tokenResponse.accessToken;
        } catch (err) {
            console.log(err);
            return null;
        }
    }

    async function fetchJSON(url, options = {}) {
        const res = await fetch(url, {
            ...options,
            headers: { ...(options.headers || {}), accept: 'application/json' }
        });
        if (!res.ok) throw new Error(res.status);
        return await res.json();
    }

    async function renderChatWidget() {
        // only for logged in
        if (!account) {
            webchatContainer.innerHTML = "";
            return;
        }
        // generate userID
        var userID = account.localAccountId ?
            account.localAccountId.substring(0, 36) :
            (Math.random().toString() + Date.now().toString()).substring(0, 64);

        let dlToken;
        try {
            const r = await fetchJSON(tokenEndpoint);
            dlToken = r.token;
        } catch(err) {
            webchatContainer.innerHTML = "<div style='color:white;padding:28px;text-align:center;'>Unable to fetch DirectLine token.<br>"+err+"</div>";
            return;
        }

        // clear container
        webchatContainer.innerHTML = "";

        const directLine = window.WebChat.createDirectLine({ token: dlToken });

        const store = WebChat.createStore(
            {},
            ({ dispatch }) => next => action => {
                if (action.type === "DIRECT_LINE/CONNECT_FULFILLED") {
                    dispatch({
                        meta: { method: "keyboard" },
                        payload: {
                            activity: {
                                channelData: { postBack: true },
                                name: 'startConversation',
                                type: "event"
                            }
                        },
                        type: "DIRECT_LINE/POST_ACTIVITY",
                    });
                }
                if (action.type === 'DIRECT_LINE/INCOMING_ACTIVITY') {
                    const activity = action.payload.activity;
                    let resourceUri;
                    if (activity.from && activity.from.role === 'bot' && (resourceUri = getOAuthCardResourceUri(activity))) {
                        exchangeTokenAsync(resourceUri).then((token) => {
                            if (token) {
                                directLine.postActivity({
                                    type: 'invoke',
                                    name: 'signin/tokenExchange',
                                    value: {
                                        id: activity.attachments[0].content.tokenExchangeResource.id,
                                        connectionName: activity.attachments[0].content.connectionName,
                                        token
                                    },
                                    "from": {
                                        id: userID,
                                        name: account.name,
                                        role: "user"
                                    }
                                }).subscribe();
                                return;
                            }
                            else {
                                return next(action);
                            }
                        });
                    } else {
                        return next(action);
                    }
                } else {
                    return next(action);
                }
            }
        );

        window.WebChat.renderWebChat(
            {
                directLine: directLine,
                store,
                userID,
                locale: 'en-US',
                styleOptions: {
                    botAvatarInitials: "Bot",
                    userAvatarInitials: "U",
                    backgroundColor: 'transparent',
                    hideUploadButton: true
                }
            },
            webchatContainer
        );
    }

    // Initial logic
    setUI();
    // If logged in, render chat
    if (msalInstance.getAllAccounts().length > 0) {
        renderChatWidget();
    }
</script>
</body>
</html>
