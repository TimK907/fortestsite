<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Travel Assistant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@700&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      min-height: 100vh;
      color: #fff;
      font-family: 'Roboto', Arial, sans-serif;
      background: url('https://images.pexels.com/photos/163856/sunset-train-road-163856.jpeg') center center/cover no-repeat;
    }
    #header-container {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 32px 0 24px 0;
      background: rgba(0,0,0,0.68);
    }
    #user-icon, #logout-icon {
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255,255,255,0.15);
      border-radius: 50%;
      cursor: pointer;
      margin-right: 28px;
    }
    #logout-icon:hover { background: rgba(255,0,0,0.11); }
    #user-icon svg, #logout-icon svg {
      width: 28px; height: 28px; fill: #fff; display: block;
    }
    #hello-text {
      font-size: 2em;
      font-weight: 700;
      color: #fff;
      margin:0 26px 0 0;
      letter-spacing: 0.8px;
      text-shadow: 0 2px 30px #000a, 0 1px 0px #0047;
      white-space: nowrap;
    }
    #ms-login-btn {
      color: #fff;
      background: #0078D4;
      font-size: 1.15em;
      padding: 12px 46px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 700;
      letter-spacing: 0.5px;
      margin-left: 22px;
      box-shadow: 0 2px 8px #0047, 0 1px 0px #0078D477;
    }
    h1 {
      text-align: center;
      margin-top: 18px;
      margin-bottom: 32px;
      font-size: 2.3em;
      letter-spacing: 2px;
      text-shadow: 0 2px 30px #000a, 0 1px 0px #0047;
      font-weight: bold;
      color: #fff;
    }
    #webchat {
      margin: 28px auto 0 auto;
      border-radius: 13px;
      overflow: hidden;
      max-width: 450px;
      max-height: 610px;
      min-height: 490px;
      box-shadow: 0 0 33px 3px #0038;
      background: rgba(0,0,0,0.56);
      display: block;
    }
  </style>
</head>
<body>
  <div id="header-container">
    <span id="user-icon" title="User" style="display: flex;">
      <!-- User icon SVG (white) -->
      <svg viewBox="0 0 24 24"><circle cx="12" cy="8.5" r="5"/><path d="M21 21c0-5-4-9-9-9s-9 4-9 9"/></svg>
    </span>
    <span id="logout-icon" title="Logout" style="display: none;">
      <!-- Logout icon SVG (white, стрілка праворуч) -->
      <svg viewBox="0 0 24 24"><path d="M14 7v-4l6 5-6 5v-4h-5v-2h5zM5 17v2h10v-2h-10z"/></svg>
    </span>
    <span id="hello-text">Hello, Anonymous User</span>
    <button id="ms-login-btn">Login with Microsoft</button>
  </div>
  <h1>Welcome to Travel Assistant.</h1>
  <div id="webchat"></div>

  <!-- MSAL.js v2.x -->
  <script src="https://alcdn.msauth.net/browser/2.38.2/js/msal-browser.min.js" defer></script>
  <!-- BotFramework Web Chat (ES5) -->
  <script src="https://cdn.botframework.com/botframework-webchat/latest/webchat-es5.js" defer></script>
  <script defer>
    window.addEventListener('DOMContentLoaded', function () {
      const msalConfig = {
        auth: {
          clientId: "05bdb70e-0233-4120-8a95-5e64e9801c84",
          authority: "https://login.microsoftonline.com/d06629ae-56db-44af-880b-80afafa24182",
          redirectUri: window.location.origin + '/',
        },
        cache: { cacheLocation: "sessionStorage", storeAuthStateInCookie: false }
      };
      let msalInstance;
      const loginRequest = { scopes: ["user.read"] };
      // Для SSO Direct Line
      const DIRECT_LINE_SSO_URL = "https://aa9a827baedfee7db575bfb7ebdcf7.17.environment.api.powerplatform.com/copilotstudio/dataverse-backed/authenticated/bots/cr7d7_undefinedNameOfTouristInformationAgen/conversations?api-version=2022-03-01-preview";
      // Для анонімного чату
      const DIRECT_LINE_ANON_URL = "https://directline.botframework.com/v3/directline/tokens/generate";
      const DIRECT_LINE_ANON_SECRET = ""; // Заміни на твій "Direct Line Secret" (налаштування Azure Bot, НЕ SSO!)

      // Elements
      const helloText = document.getElementById('hello-text');
      const loginBtn = document.getElementById('ms-login-btn');
      const userIcon = document.getElementById('user-icon');
      const logoutIcon = document.getElementById('logout-icon');
      const webchatDiv = document.getElementById('webchat');
      let msalAccount = null;
      let msalReady = false, interactionInProgress = false;

      function setLoggedOutUI() {
        helloText.textContent = "Hello, Anonymous User";
        loginBtn.style.display = '';
        userIcon.style.display = 'flex';
        logoutIcon.style.display = 'none';
      }
      function setLoggedInUI(username) {
        helloText.textContent = "Hello, " + username;
        loginBtn.style.display = 'none';
        userIcon.style.display = 'none';
        logoutIcon.style.display = 'flex';
      }

      // ---- MSAL ----
      function safeMsalInit() {
        if (!window.msal || !window.msal.PublicClientApplication) {
          setTimeout(safeMsalInit, 60); return;
        }
        msalReady = true;
        msalInstance = new msal.PublicClientApplication(msalConfig);
        msalInstance.handleRedirectPromise()
          .then(res => {
            interactionInProgress = false;
            let account = res && res.account ? res.account : msalInstance.getAllAccounts()[0];
            if(account) {
              msalAccount = account;
              onLoggedIn();
            } else {
              setLoggedOutUI();
              if (!webchatRendered) renderWebchatAnonymous();
            }
          })
          .catch(e => {
            interactionInProgress = false;
            setLoggedOutUI();
            if (!webchatRendered) renderWebchatAnonymous();
          });
      }
      // UI
      loginBtn.onclick = function() {
        if (!msalInstance || interactionInProgress) return;
        interactionInProgress = true;
        msalInstance.loginRedirect(loginRequest);
      };
      userIcon.onclick = () => {};
      logoutIcon.onclick = function() {
        if (msalInstance && msalAccount) msalInstance.logoutRedirect();
      };
      function onLoggedIn() {
        msalInstance.acquireTokenSilent(loginRequest).then(response=>{
          if(response && response.account) {
            msalAccount = response.account;
            setLoggedInUI(msalAccount.username);
            renderWebchatSSO(response.accessToken);
          }
        }).catch(err=>{
          if (err instanceof msal.InteractionRequiredAuthError) {
            setLoggedOutUI();
            if (!webchatRendered) renderWebchatAnonymous();
          }
        });
      }

      // ---- WEBCHAT (SSO і анонімний) ----
      let webchatRendered = false;
      function renderWebchatSSO(msAccessToken){
        if (webchatRendered || !window.WebChat) return;
        fetch(DIRECT_LINE_SSO_URL, {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + msAccessToken,
            'Content-Type': 'application/json'
          }
        })
        .then(res => res.json())
        .then(data => {
          const { token } = data;
          if(!token) throw new Error("Failed to obtain DirectLine SSO token");
          webchatRendered = true;
          window.WebChat.renderWebChat({
            directLine: window.WebChat.createDirectLine({ token }),
            userID: msalAccount.homeAccountId || msalAccount.localAccountId || msalAccount.username,
            locale: 'en-US',
            styleOptions: {
              backgroundColor: 'rgba(0,0,0,0.18)',
              botAvatarInitials: 'TA',
              userAvatarInitials: 'ME',
              bubbleBackground: 'rgba(11,60,170,0.19)',
              bubbleTextColor: '#fff',
              bubbleBorder: '1px solid #0078D4',
              bubbleBorderRadius: 15,
              bubbleFromUserTextColor: '#fff',
              bubbleFromUserBackground: '#0078D4',
            }
          }, webchatDiv);
        }).catch(err => {
          webchatDiv.innerHTML = '<div style="color:#fff; background:#F33; padding:16px; border-radius:10px;">Failed to load bot chat.<br>' + err + '</div>';
        });
      }
      function renderWebchatAnonymous(){
        if (webchatRendered || !window.WebChat) return;
        if (!DIRECT_LINE_ANON_SECRET) {
          webchatDiv.innerHTML = '<div style="color:#fff; background:#F33; padding:16px; border-radius:10px;">DirectLine Secret is required for anonymous chat.<br>Configure DIRECT_LINE_ANON_SECRET in the code.</div>';
          return;
        }
        fetch(DIRECT_LINE_ANON_URL, {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + DIRECT_LINE_ANON_SECRET }
        })
        .then(res => res.json())
        .then(data => {
          const token = data.token;
          if(!token) throw new Error("Failed to obtain DirectLine anon token");
          webchatRendered = true;
          window.WebChat.renderWebChat({
            directLine: window.WebChat.createDirectLine({ token }),
            locale: 'en-US',
            styleOptions: {
              backgroundColor: 'rgba(0,0,0,0.18)',
              botAvatarInitials: 'TA',
              userAvatarInitials: 'ME',
              bubbleBackground: 'rgba(11,60,170,0.19)',
              bubbleTextColor: '#fff',
              bubbleBorder: '1px solid #0078D4',
              bubbleBorderRadius: 15,
              bubbleFromUserTextColor: '#fff',
              bubbleFromUserBackground: '#0078D4',
            }
          }, webchatDiv);
        }).catch(err => {
          webchatDiv.innerHTML = '<div style="color:#fff; background:#F33; padding:16px; border-radius:10px;">Failed to load anonymous bot chat.<br>' + err + '</div>';
        });
      }

      // INIT
      setLoggedOutUI();
      safeMsalInit();
      // Якщо MSAL не залогований/фейл, покажемо анонімний чат автоматично у safeMsalInit
    });
  </script>
</body>
</html>
