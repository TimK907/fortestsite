<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Travel Assistant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- ...STYLE як раніше... -->
</head>
<body>
  <!-- ...HTML markup як у попередньому файлі... -->
  <div id="topbar">
    <div class="user-block" id="user-block">
      <span class="user-icon" id="userIcon">
        <svg viewBox="0 0 24 24"><circle cx="12" cy="8.5" r="4.5"/><path d="M21 21c0-4.418-3.582-8-8-8s-8 3.582-8 8"/></svg>
      </span>
      <span id="hello-text">Hello, Anonymous User</span>
      <button id="ms-login-btn">Login with Microsoft</button>
    </div>
  </div>
  <h1>Welcome to Travel Assistant.</h1>
  <div id="webchat"></div>

  <!-- Підключення бібліотек через CDN, з defer! -->
  <script src="https://alcdn.msauth.net/browser/2.38.2/js/msal-browser.min.js" defer></script>
  <script src="https://cdn.botframework.com/botframework-webchat/latest/webchat-es5.js" defer></script>

  <!-- Весь твій js тепер в окремому <script defer> -->
  <script defer>
window.addEventListener('DOMContentLoaded', function () {
  // ====  PARAMS ----
  const msalConfig = {
    auth: {
      clientId: "05bdb70e-0233-4120-8a95-5e64e9801c84",
      authority: "https://login.microsoftonline.com/d06629ae-56db-44af-880b-80afafa24182",
      redirectUri: window.location.origin + '/', // ДОДАВАТИ цей URI в Azure
    },
    cache: { cacheLocation: "sessionStorage", storeAuthStateInCookie: false }
  };
  const msalInstance = new msal.PublicClientApplication(msalConfig);

  const loginRequest = { scopes: ["user.read"] };

  const DIRECT_LINE_SSO_URL = "https://aa9a827baedfee7db575bfb7ebdcf7.17.environment.api.powerplatform.com/copilotstudio/dataverse-backed/authenticated/bots/cr7d7_undefinedNameOfTouristInformationAgen/conversations?api-version=2022-03-01-preview";

  const helloText = document.getElementById('hello-text');
  const loginBtn = document.getElementById('ms-login-btn');
  const userIconContainer = document.getElementById('userIcon');
  let msalAccount = null;

  function setLoggedUser(name) {
    helloText.textContent = "Hello, " + name;
    loginBtn.style.display = 'none';
    userIconContainer.innerHTML = `<svg viewBox="0 0 24 24"><path d="M10,17V21H4V3H10V7H8V19H10M17.65,11.65L19.5,13.5L17,16V13.5H12V10.5H17V8L19.5,10.5L17.65,11.65Z" /></svg>`;
    userIconContainer.className = "logout-icon";
    userIconContainer.title = "Logout";
  }
  function setAnonymous() {
    helloText.textContent = "Hello, Anonymous User";
    loginBtn.style.display = 'inline-block';
    userIconContainer.innerHTML = `<svg viewBox="0 0 24 24"><circle cx="12" cy="8.5" r="4.5"/><path d="M21 21c0-4.418-3.582-8-8-8s-8 3.582-8 8"/></svg>`;
    userIconContainer.className = "user-icon";
    userIconContainer.title = "";
  }

  function trySilentLogin() {
    msalInstance.handleRedirectPromise().then(res => {
      let account = res && res.account ? res.account : msalInstance.getAllAccounts()[0];
      if(account) {
        msalAccount = account;
        showLoggedIn();
      } else {
        setAnonymous();
      }
    }).catch(e=>{ setAnonymous(); });
  }
  function showLoggedIn() {
    msalInstance.acquireTokenSilent(loginRequest).then(response=>{
      if(response && response.account) {
        msalAccount = response.account;
        setLoggedUser(msalAccount.username);
        renderWebChatWithSSO(response.accessToken);
      }
    }).catch(err=>{
      if (err instanceof msal.InteractionRequiredAuthError) {
        setAnonymous();
      }
    });
  }
  loginBtn.onclick = function() {
    msalInstance.loginRedirect(loginRequest);
  };
  userIconContainer.onclick = function() {
    if (msalAccount) {
      msalInstance.logoutRedirect();
    }
  };

  let webchatRendered = false;
  function renderWebChatWithSSO(msAccessToken) {
    if (webchatRendered) return;
    fetch(DIRECT_LINE_SSO_URL, {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + msAccessToken,
        'Content-Type': 'application/json'
      }
    })
    .then(res => res.json())
    .then(data => {
      const { token } = data;
      if(!token) throw new Error("Failed to obtain DirectLine SSO token");
      window.WebChat.renderWebChat({
        directLine: window.WebChat.createDirectLine({ token }),
        userID: msalAccount.homeAccountId || msalAccount.localAccountId || msalAccount.username,
        locale: 'en-US',
        styleOptions: {
          backgroundColor: 'rgba(0,0,0,0.18)',
          botAvatarInitials: 'TA',
          userAvatarInitials: 'ME',
          bubbleBackground: 'rgba(11,60,170,0.19)',
          bubbleTextColor: '#fff',
          bubbleBorder: '1px solid #0078D4',
          bubbleBorderRadius: 15,
          bubbleFromUserTextColor: '#fff',
          bubbleFromUserBackground: '#0078D4',
        }
      }, document.getElementById('webchat'));
      webchatRendered = true;
    }).catch(err => {
      document.getElementById('webchat').innerHTML = '<div style="color:#fff; background:#F33; padding:14px; border-radius:10px;">Failed to load bot chat.<br>' + err + '</div>';
    });
  }
  trySilentLogin();
});
  </script>
</body>
</html>
